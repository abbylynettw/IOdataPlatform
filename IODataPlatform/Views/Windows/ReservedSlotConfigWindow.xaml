<ui:FluentWindow x:Class="IODataPlatform.Views.Windows.ReservedSlotConfigWindow"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             mc:Ignorable="d"
             Title="预留插槽配置"
             Width="900"
             Height="600"
             WindowStartupLocation="CenterOwner"
             ExtendsContentIntoTitleBar="True"
             WindowBackdropType="Mica">

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 说明文字 -->
        <StackPanel Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="预留插槽配置" 
                       FontSize="18" 
                       FontWeight="SemiBold"
                       Margin="0,0,0,8"/>
            <TextBlock Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                       TextWrapping="Wrap"
                       LineHeight="22">
                <Run Text="为每个机柜的最后一个机笼配置预留的通讯板卡插槽，插槽从后往前分配。"/>
                <LineBreak/>
                <Run Text="配置完成后将继续进行IO自动分配。" FontWeight="Medium"/>
            </TextBlock>
            <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
                    CornerRadius="4"
                    Padding="10,8"
                    Margin="0,8,0,0">
                <TextBlock Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           FontSize="12">
                    <Run Text="• 勾选“启用预留”后，请设置预留插槽数量"/>
                    <LineBreak/>
                    <Run Text="• 系统将自动在最后一个机笼的倒数第N个插槽中放置预留板卡"/>
                    <LineBreak/>
                    <Run Text="• 可为每个插槽选择板卡类型（MD211/MD216/DP211），点击图标切换预留目的（"/>
                    <Run FontFamily="Segoe Fluent Icons" FontSize="11" Text="" Foreground="{DynamicResource SystemAccentColorSecondaryBrush}"/>
                    <Run Text="通讯/"/>
                    <Run FontFamily="Segoe Fluent Icons" FontSize="11" Text="" Foreground="#FF6B35"/>
                    <Run Text="报警）"/>
                </TextBlock>
            </Border>
        </StackPanel>

        <!-- DataGrid -->
        <Border Grid.Row="1" 
                BorderThickness="1" 
                BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                CornerRadius="4"
                Margin="0,0,0,12">
            <DataGrid x:Name="CabinetDataGrid"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      CanUserReorderColumns="False"
                      CanUserSortColumns="True"
                      GridLinesVisibility="All"
                      HeadersVisibility="All"
                      SelectionMode="Single"
                      RowHeight="45"
                      AlternatingRowBackground="{DynamicResource SubtleFillColorSecondaryBrush}">
                <DataGrid.Columns>
                    <!-- 选择列 - 使用模板列增大可点击区域 -->
                    <DataGridTemplateColumn Header="启用预留" Width="80">
                        <DataGridTemplateColumn.HeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                <Setter Property="Padding" Value="10,8"/>
                            </Style>
                        </DataGridTemplateColumn.HeaderStyle>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"
                                          Margin="5"
                                          MinWidth="30"
                                          MinHeight="30"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- 机柜名称列 -->
                    <DataGridTextColumn Header="机柜名称" 
                                        Binding="{Binding CabinetName}"
                                        IsReadOnly="True"
                                        Width="150">
                        <DataGridTextColumn.HeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Padding" Value="10,8"/>
                            </Style>
                        </DataGridTextColumn.HeaderStyle>
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Padding" Value="10,0"/>
                                <Setter Property="FontSize" Value="14"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    
                    <!-- 板卡配置列表列 -->
                    <DataGridTemplateColumn Header="板卡配置" Width="*">
                        <DataGridTemplateColumn.HeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                <Setter Property="Padding" Value="10,8"/>
                            </Style>
                        </DataGridTemplateColumn.HeaderStyle>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Vertical" Margin="5">
                                    <StackPanel Orientation="Horizontal">
                                        <!-- 板卡配置列表 -->
                                        <ItemsControl ItemsSource="{Binding SlotConfigs}" Margin="0,0,8,0">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
                                                            BorderThickness="1"
                                                            CornerRadius="3"
                                                            Padding="4,2"
                                                            Margin="0,1,3,1"
                                                            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}">
                                                        <StackPanel Orientation="Horizontal">
                                                            <!-- 板卡类型选择 -->
                                                            <ComboBox ItemsSource="{Binding AvailableCardTypes}"
                                                                      SelectedItem="{Binding SelectedCardType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                      Width="85"
                                                                      Height="22"
                                                                      FontSize="10"
                                                                      Padding="3,1"
                                                                      Margin="0,0,3,0"/>
                                                            <!-- 预留目的切换按钮 -->
                                                            <ui:Button ToolTip="{Binding ReservedPurpose}"
                                                                       Width="24"
                                                                       Height="22"
                                                                       Padding="2"
                                                                       FontSize="10"
                                                                       Margin="0,0,3,0"
                                                                       Tag="{Binding}"
                                                                       Click="TogglePurposeButton_Click">
                                                                <ui:Button.Style>
                                                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                                        <Setter Property="Appearance" Value="Secondary"/>
                                                                        <Setter Property="Icon" Value="{ui:SymbolIcon PlugConnected24}"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding ReservedPurpose}" Value="2">
                                                                                <Setter Property="Icon" Value="{ui:SymbolIcon Alert24}"/>
                                                                                <Setter Property="Foreground" Value="#FF6B35"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </ui:Button.Style>
                                                            </ui:Button>
                                                            <!-- 删除按钮 -->
                                                            <ui:Button Appearance="Danger"
                                                                       Icon="{ui:SymbolIcon Delete16}"
                                                                       ToolTip="删除此预留插槽"
                                                                       Width="20"
                                                                       Height="20"
                                                                       Padding="0"
                                                                       FontSize="9"
                                                                       Tag="{Binding}"
                                                                       Click="DeleteSlotButton_Click"/>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                        <!-- 添加按钮 - 放在后面 -->
                                        <ui:Button Icon="{ui:SymbolIcon Add20}"
                                                   ToolTip="添加预留插槽"
                                                   Appearance="Secondary"
                                                   Width="26"
                                                   Height="26"
                                                   Padding="0"
                                                   VerticalAlignment="Top"
                                                   Tag="{Binding}"
                                                   Click="AddSlotButton_Click">
                                            <ui:Button.Style>
                                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                                    <Style.Triggers>
                                                        <!-- 只有启用时才可用 -->
                                                        <DataTrigger Binding="{Binding IsSelected}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- 底部按钮 -->
        <StackPanel Grid.Row="2" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right">
            <ui:Button x:Name="ConfirmButton"
                       Content="确定并继续IO分配"
                       Icon="{ui:SymbolIcon ArrowRight24}"
                       Appearance="Primary"
                       Margin="0,0,10,0"
                       MinWidth="160"
                       Height="36"
                       Click="ConfirmButton_Click"/>
            <ui:Button x:Name="CancelButton"
                       Content="取消"
                       Icon="{ui:SymbolIcon Dismiss24}"
                       Appearance="Secondary"
                       MinWidth="100"
                       Height="36"
                       Click="CancelButton_Click"/>
        </StackPanel>
    </Grid>
</ui:FluentWindow>
