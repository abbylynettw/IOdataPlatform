<Page x:Class="IODataPlatform.Views.SubPages.Common.CabinetAllocatedPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:local="clr-namespace:IODataPlatform.Views.SubPages.Common"
    xmlns:xlmodel="clr-namespace:IODataPlatform.Models.ExcelModels"
    xmlns:ly="http://lysoft/wpf"
    xmlns:cus="clr-namespace:LYSoft.Libs.Wpf.WpfUI.Custom;assembly=LYSoft.Libs.Wpf.WpfUI"
    ui:NavigationView.HeaderContent="IO分配预览"
    d:DataContext="{d:DesignInstance Type=local:CabinetAllocatedPage}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    mc:Ignorable="d" 
    ScrollViewer.CanContentScroll="False"
    Title="CabinetAllocatedPage">

    <Page.Resources>
        <ly:NullToBooleanConverter IsInverse="True" x:Key="NullToBooleanConverter"/>
        <ly:NullToBooleanConverter IsInverse="False" x:Key="NullToBoolConverter"/>
        <ly:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <ly:NullToVisibilityConverter Inverse="True" x:Key="NullToVisibilityConverterInverse"/>
        <local:BorderBrushValueConverter x:Key="BorderBrushValueConverter"/>
        <local:ChannelForegroundValueConverter x:Key="ChannelForegroundValueConverter"/>
        <local:PointToBrushConverter x:Key="PointToBrushConverter"/>
        <local:FFBusVisibilityConverter x:Key="FFBusVisibilityConverter"/>
        <local:FFSlaveVisibilityConverter x:Key="FFSlaveVisibilityConverter"/>
        <local:CommunicationBoardVisibilityConverter x:Key="CommunicationBoardVisibilityConverter"/>
        <local:NormalBoardVisibilityConverter x:Key="NormalBoardVisibilityConverter"/>
        <local:NetworkBorderBrushConverter x:Key="NetworkBorderBrushConverter"/>
        <local:NetworkBackgroundBrushConverter x:Key="NetworkBackgroundBrushConverter"/>
        <local:ModuleBorderBrushConverter x:Key="ModuleBorderBrushConverter"/>
        <local:ModuleBackgroundBrushConverter x:Key="ModuleBackgroundBrushConverter"/>
        <local:BoardBorderBrushConverter x:Key="BoardBorderBrushConverter"/>
        <local:BoardBackgroundBrushConverter x:Key="BoardBackgroundBrushConverter"/>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="auto"/>
            <RowDefinition Height="auto" MaxHeight="300"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="auto" MinWidth="731"/>
            <ColumnDefinition Width="auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <ui:CardExpander Grid.ColumnSpan="100">
            <ui:CardExpander.Header>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="auto"/>
                    </Grid.ColumnDefinitions>

                    <ui:TextBlock Text="操作说明" VerticalAlignment="Center"/>
                    <StackPanel Orientation="Horizontal" Grid.Column="1">
                        <Menu>
                            <ui:MenuItem Header="IO分配"
                                         Icon="{ui:SymbolIcon DeveloperBoard16}">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="冗余率"
                                               VerticalAlignment="Center" />
                                    <Slider Margin="10,0,0,0"
                                            x:Name="SliderRedundancy"
                                            Minimum="0"
                                            Maximum="100"
                                            Value="{Binding ViewModel.RedundancyRate}"
                                            IsSnapToTickEnabled="True"
                                            Width="150" />
                                    <TextBlock Width="25"
                                               TextAlignment="Center"
                                               Text="{Binding ElementName=SliderRedundancy, Path=Value, Mode=OneWay}"
                                               VerticalAlignment="Center" />
                                    <TextBlock Text="%"
                                               VerticalAlignment="Center" />
                                </StackPanel>
                                <ui:MenuItem Header="IO自动分配"
                                             Command="{Binding ViewModel.AllocateIOCommand}" />
                                <ui:MenuItem Header="增加报警点"
                                             Icon="{ui:SymbolIcon Add24}"
                                             Command="{Binding ViewModel.AddTagCommand}"
                                             CommandParameter="{x:Static xlmodel:TagType.Alarm}" />
                                <ui:MenuItem Header="删除报警点"
                                             Icon="{ui:SymbolIcon Delete24}"
                                             Command="{Binding ViewModel.DeleteTagCommand}"
                                             CommandParameter="{x:Static xlmodel:TagType.Alarm}" />
                                <ui:MenuItem Header="增加备用点"
                                              Icon="{ui:SymbolIcon Add24}"
                                              Command="{Binding ViewModel.AddTagCommand}"
                                              CommandParameter="{x:Static xlmodel:TagType.BackUp}" />
                                                                <ui:MenuItem Header="删除备用点"
                                              Icon="{ui:SymbolIcon Delete24}"
                                              Command="{Binding ViewModel.DeleteTagCommand}"
                                              CommandParameter="{x:Static xlmodel:TagType.BackUp}" />
                            </ui:MenuItem>
                            <ui:MenuItem Header="重新计算"
                                         Margin="0,0,10,0"
                                         Icon="{ui:SymbolIcon Calculator24}"
                                         Command="{Binding ViewModel.RecalcCommand}" />
                        </Menu>
                        
                        <Menu>
                            <ui:MenuItem Header="显示列" 
                                         Icon="{ui:SymbolIcon Settings24}"
                                         Click="ShowColumnsDialog_Click"/>
                        </Menu>
                        
                        <ui:TextBlock Margin="0,0,10,0" Text="选择机柜" VerticalAlignment="Center"/>
                        <ComboBox Margin="0,0,10,0" ItemsSource="{Binding ViewModel.Cabinets}" SelectedItem="{Binding ViewModel.Cabinet}" MinWidth="150">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <ui:TextBlock Text="{Binding Name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        <Grid Margin="0,0,10,0" Background="#01000000" AllowDrop="True" DragOver="DeleteDragOver" Drop="DeleteDrop"> 
                            <ui:SymbolIcon Symbol="Delete24" Foreground="Red" FontSize="20" VerticalAlignment="Center"/>
                        </Grid>
                        <ui:Button Margin="0,0,10,0" Grid.Column="1" Content="保存" Command="{Binding ViewModel.SaveCommand}"/>
                    </StackPanel>
                </Grid>
            </ui:CardExpander.Header>
            <StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="1.本页面所有出现"/>
                    <ui:SymbolIcon Symbol="ArrowMove24" Margin="1,0" VerticalAlignment="Center"/>
                    <TextBlock Text="图标的对象均可被拖拽移动，可拖拽的对象有卡件和点两种"/>
                </StackPanel>
                <TextBlock Text="2.卡件可拖拽至”未分配卡件“面板或插槽中，如插槽中已有卡件，则会将已有卡件移动至”未分配卡件“面板中"/>
                <TextBlock Text="3.卡件可拖拽至”查看卡件“面板中，可查看卡件中的所有点，想移动卡件中的点，也需要在”查看卡件“面板中操作"/>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="4.空白卡件可拖拽至页面右上角的"/>
                    <ui:SymbolIcon Symbol="Delete24" Margin="1,0" Foreground="Red" VerticalAlignment="Center"/>
                    <TextBlock Text="图标上，可以删除该卡件"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="5.单击插槽或”未分配卡件“面板中的"/>
                    <ui:SymbolIcon Symbol="Add24" Margin="1,0" VerticalAlignment="Center"/>
                    <TextBlock Text="图标，可以在相应位置添加一个新的卡件"/>
                </StackPanel>
                <TextBlock Text="6.点可拖拽至”未分配点“面板或卡件的通道上，如通道上已有点，则会将已有点移动至”未分配点“面板中"/>
                <TextBlock Text="7.切换机柜前和从此页面离开前均需要保存 ，系统会舍弃未保存的数据"/>
            </StackPanel>
        </ui:CardExpander>

        <Grid Grid.Row="1" Grid.RowSpan="100">
            <Grid.RowDefinitions>
                <RowDefinition Height="auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <StackPanel Orientation="Horizontal">
                <ui:TextBlock Margin="10,0,0,0" Text="就地箱号" VerticalAlignment="Center"/>
                <ComboBox Margin="10,0,0,0" ItemsSource="{Binding ViewModel.LocalBoxNumberOptions}" SelectedItem="{Binding ViewModel.LocalBoxNumber1}" VerticalAlignment="Center" MinWidth="150"/>
                <ui:TextBlock Margin="10,0,0,0" Text="供电类型" VerticalAlignment="Center"/>
                <ComboBox Margin="10,0,0,0" ItemsSource="{Binding ViewModel.PowerTypeOptions}" SelectedItem="{Binding ViewModel.PowerType1}" VerticalAlignment="Center" MinWidth="150"/>
            </StackPanel>
            
            <ScrollViewer Grid.Row="1" Grid.RowSpan="100">
                <ItemsControl Grid.Row="1" ItemsSource="{Binding ViewModel.Cabinet.Cages}" HorizontalAlignment="Left">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" BorderThickness="1" Margin="3" Padding="0,0,3,0">
                                <!--这是机笼-->
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="10,5,0,0">
                                        <ui:TextBlock Text="机笼：" VerticalAlignment="Center"/>
                                        <ui:TextBlock Text="{Binding Index}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <ItemsControl ItemsSource="{Binding Slots}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border BorderThickness="1" Margin="3,3,0,3" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" AllowDrop="True" DragOver="SlotDragOver" Drop="SlotDrop" Tag="{Binding}">
                                                    <Border.Background>
                                                        <MultiBinding Converter="{StaticResource BorderBrushValueConverter}">
                                                            <Binding Path="Board"/>
                                                            <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.ViewBoard"/>
                                                        </MultiBinding>
                                                    </Border.Background>
                                                    <!--这是插槽-->
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="auto"/>
                                                            <RowDefinition Height="*"/>
                                                        </Grid.RowDefinitions>

                                                        <StackPanel Orientation="Horizontal" Margin="3,3,0,0">
                                                            <ui:TextBlock Text="{Binding Index}"/>
                                                            <ui:TextBlock Margin="2,0,0,0" Text="{Binding Board.Type}"/>
                                                            <!-- FF总线箱标签（仅在板卡存在时显示） -->
                                                            <ui:TextBlock Text=" [总线]" FontSize="8" FontWeight="Bold" Foreground="#FF4A90E2">
                                                                <ui:TextBlock.Style>
                                                                    <Style TargetType="ui:TextBlock">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                        <Style.Triggers>
                                                                            <MultiDataTrigger>
                                                                                <MultiDataTrigger.Conditions>
                                                                                    <Condition Binding="{Binding Board, Converter={StaticResource NullToBoolConverter}}" Value="True"/>
                                                                                    <Condition Binding="{Binding Board.FFBoardType, Converter={StaticResource FFBusVisibilityConverter}}" Value="Visible"/>
                                                                                </MultiDataTrigger.Conditions>
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                            </MultiDataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </ui:TextBlock.Style>
                                                            </ui:TextBlock>
                                                            <!-- FF从站箱标签（仅在板卡存在时显示） -->
                                                            <ui:TextBlock Text=" [从站]" FontSize="8" FontWeight="Bold" Foreground="#FFFF8C00">
                                                                <ui:TextBlock.Style>
                                                                    <Style TargetType="ui:TextBlock">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                        <Style.Triggers>
                                                                            <MultiDataTrigger>
                                                                                <MultiDataTrigger.Conditions>
                                                                                    <Condition Binding="{Binding Board, Converter={StaticResource NullToBoolConverter}}" Value="True"/>
                                                                                    <Condition Binding="{Binding Board.FFBoardType, Converter={StaticResource FFSlaveVisibilityConverter}}" Value="Visible"/>
                                                                                </MultiDataTrigger.Conditions>
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                            </MultiDataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </ui:TextBlock.Style>
                                                            </ui:TextBlock>
                                                        </StackPanel>

                                                        <Grid Grid.Row="1" Margin="3">
                                                            <Border Width="61" MinHeight="94" VerticalAlignment="Stretch" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" Visibility="{Binding Board, Converter={StaticResource NullToVisibilityConverterInverse}, Mode=OneWay}">
                                                                <ui:Button Appearance="Transparent" BorderThickness="0" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" Icon="{ui:SymbolIcon Add24, True}" CommandParameter="{Binding}"
                                                         Command="{Binding RelativeSource={RelativeSource AncestorType=local:CabinetAllocatedPage}, Path=ViewModel.AddBoardToSlotCommand}"/>
                                                            </Border>

                                                            <Border Width="61" MinHeight="94" VerticalAlignment="Stretch" BorderThickness="1"
                                                                    BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                              Visibility="{Binding Board, Converter={StaticResource NullToVisibilityConverter}, Mode=OneWay}">
                                                                <Border.Background>
                                                                    <MultiBinding Converter="{StaticResource BoardBackgroundBrushConverter}">
                                                                        <Binding Path="Board"/>
                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedBoard"/>
                                                                    </MultiBinding>
                                                                </Border.Background>
                                                                <StackPanel>
                                                                    <!-- 拖动按钮 -->
                                                                    <Border Background="#01000000" Margin="3" Height="18" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                      MouseDown="BoardDragStart" Tag="{Binding Board}">
                                                                        <ui:SymbolIcon Symbol="ArrowMove24"/>
                                                                    </Border>
                                                                    <!-- 查看按钮（所有板卡都显示） -->
                                                                    <Border Background="#01000000" Margin="3,0,3,3" Height="18" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                      Cursor="Hand" MouseLeftButtonDown="ViewBoardClick" Tag="{Binding Board}">
                                                                        <ui:SymbolIcon Symbol="Eye24"/>
                                                                    </Border>
                                                                    
                                                                    <!-- FF总线板卡显示（双网段框结构） -->
                                                                    <StackPanel Visibility="{Binding Board.FFBoardType, Converter={StaticResource FFBusVisibilityConverter}}">
                                                                        <ItemsControl ItemsSource="{Binding Board.Networks}">
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <!-- 网段框：可点击查看网段信号（选中背景变红） -->
                                                                                    <Border Margin="3,2" BorderThickness="2" CornerRadius="3"
                                                                                            BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                            Cursor="Hand"
                                                                                            MouseLeftButtonDown="NetworkBorder_Click"
                                                                                            Tag="{Binding}">
                                                                                        <Border.Background>
                                                                                            <MultiBinding Converter="{StaticResource NetworkBackgroundBrushConverter}">
                                                                                                <Binding/>
                                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedNetwork"/>
                                                                                            </MultiBinding>
                                                                                        </Border.Background>
                                                                                        <StackPanel>
                                                                                            <!-- 网段标题 -->
                                                                                            <ui:TextBlock Margin="3,2,3,1" FontSize="9" 
                                                                                                          Text="{Binding NetworkType}" 
                                                                                                          HorizontalAlignment="Center" 
                                                                                                          FontWeight="Bold"
                                                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                                            
                                                                                            <!-- 信号列表（使用圆点显示，2列布局） -->
                                                                                            <ItemsControl ItemsSource="{Binding FFBusChannels}">
                                                                                                <ItemsControl.ItemsPanel>
                                                                                                    <ItemsPanelTemplate>
                                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                                    </ItemsPanelTemplate>
                                                                                                </ItemsControl.ItemsPanel>
                                                                                                <ItemsControl.ItemTemplate>
                                                                                                    <DataTemplate>
                                                                                                        <!-- 圆点显示 -->
                                                                                                        <Border Width="14" Height="14" Margin="2" 
                                                                                                                CornerRadius="7"
                                                                                                                BorderThickness="1" 
                                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" 
                                                                                                                Tag="{Binding}" 
                                                                                                                Background="{Binding Point,Converter={StaticResource PointToBrushConverter}}">
                                                                                                            <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7">
                                                                                                                <ui:TextBlock.Foreground>
                                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                                        <Binding Path="Point"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                                    </MultiBinding>
                                                                                                                </ui:TextBlock.Foreground>
                                                                                                            </ui:TextBlock>
                                                                                                        </Border>
                                                                                                    </DataTemplate>
                                                                                                </ItemsControl.ItemTemplate>
                                                                                            </ItemsControl>
                                                                                        </StackPanel>
                                                                                    </Border>
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>
                                                                    </StackPanel>
                                                                    
                                                                    <!-- FF从站板卡显示（双网段框结构） -->
                                                                    <StackPanel Visibility="{Binding Board.FFBoardType, Converter={StaticResource FFSlaveVisibilityConverter}}">
                                                                        <ItemsControl ItemsSource="{Binding Board.Networks}">
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <!-- 网段框：可点击选中（选中背景变红） -->
                                                                                    <Border Margin="3,2" BorderThickness="2" CornerRadius="3"
                                                                                            BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                            Cursor="Hand"
                                                                                            MouseLeftButtonDown="NetworkBorder_Click"
                                                                                            Tag="{Binding}">
                                                                                        <Border.Background>
                                                                                            <MultiBinding Converter="{StaticResource NetworkBackgroundBrushConverter}">
                                                                                                <Binding/>
                                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedNetwork"/>
                                                                                            </MultiBinding>
                                                                                        </Border.Background>
                                                                                        <StackPanel>
                                                                                            <!-- 网段标题 -->
                                                                                            <ui:TextBlock Margin="3,2,3,1" FontSize="9" 
                                                                                                          Text="{Binding NetworkType}" 
                                                                                                          HorizontalAlignment="Center" 
                                                                                                          FontWeight="Bold"
                                                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                                            
                                                                                            <!-- 未分配信号列表（当没有模块时显示） -->
                                                                                            <ItemsControl ItemsSource="{Binding UnallocatedSignals}">
                                                                                                <ItemsControl.Style>
                                                                                                    <Style TargetType="ItemsControl">
                                                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                                                        <Style.Triggers>
                                                                                                            <!-- 当模块列表为空时显示未分配信号 -->
                                                                                                            <DataTrigger Binding="{Binding Modules.Count}" Value="0">
                                                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                                                            </DataTrigger>
                                                                                                        </Style.Triggers>
                                                                                                    </Style>
                                                                                                </ItemsControl.Style>
                                                                                                <ItemsControl.ItemsPanel>
                                                                                                    <ItemsPanelTemplate>
                                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                                    </ItemsPanelTemplate>
                                                                                                </ItemsControl.ItemsPanel>
                                                                                                <ItemsControl.ItemTemplate>
                                                                                                    <DataTemplate>
                                                                                                        <!-- 未分配信号方块（橙色边框提示） -->
                                                                                                        <Border Width="25" Height="14" Margin="0.5" BorderThickness="1" 
                                                                                                                BorderBrush="Orange"
                                                                                                                Background="{Binding Converter={StaticResource PointToBrushConverter}}">
                                                                                                            <ui:TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7"
                                                                                                                          Text="0">
                                                                                                                <ui:TextBlock.Foreground>
                                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                                        <Binding/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                                    </MultiBinding>
                                                                                                                </ui:TextBlock.Foreground>
                                                                                                            </ui:TextBlock>
                                                                                                        </Border>
                                                                                                    </DataTemplate>
                                                                                                </ItemsControl.ItemTemplate>
                                                                                            </ItemsControl>
                                                                                            
                                                                                            <!-- 模块列表（仅显示FF分配后的模块） -->
                                                                                            <ItemsControl ItemsSource="{Binding Modules}">
                                                                                                <ItemsControl.ItemTemplate>
                                                                                                    <DataTemplate>
                                                                                                        <!-- 模块容器：可点击选中，选中背景变红 -->
                                                                                                        <Border Margin="1,1,1,2" BorderThickness="0.5" CornerRadius="2"
                                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                                Cursor="Hand"
                                                                                                                MouseLeftButtonDown="ModuleBorder_Click"
                                                                                                                Tag="{Binding}">
                                                                                                            <Border.Background>
                                                                                                                <MultiBinding Converter="{StaticResource ModuleBackgroundBrushConverter}">
                                                                                                                    <Binding/>
                                                                                                                    <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedModule"/>
                                                                                                                </MultiBinding>
                                                                                                            </Border.Background>
                                                                                                            <StackPanel Margin="1">
                                                                                                                <!-- 模块标题：加粗、调整宽度 -->
                                                                                                                <ui:TextBlock Margin="2,1" FontSize="8" FontWeight="Bold" HorizontalAlignment="Center" TextWrapping="Wrap" MaxWidth="55">
                                                                                                                <ui:TextBlock.Style>
                                                                                                                    <Style TargetType="ui:TextBlock">
                                                                                                                        <!-- 默认显示站号+型号 -->
                                                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                                                        <Style.Triggers>
                                                                                                                            <!-- BUS虚拟模块隐藏标题 -->
                                                                                                                            <DataTrigger Binding="{Binding ModuleType}" Value="BUS">
                                                                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                                                            </DataTrigger>
                                                                                                                            <!-- “未分配”模块显示“⚠ 待分配” -->
                                                                                                                            <DataTrigger Binding="{Binding ModuleType}" Value="未分配">
                                                                                                                                <Setter Property="Text" Value="⚠ 待分配"/>
                                                                                                                                <Setter Property="Foreground" Value="Orange"/>
                                                                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                                                                            </DataTrigger>
                                                                                                                        </Style.Triggers>
                                                                                                                    </Style>
                                                                                                </ui:TextBlock.Style>
                                                                                                                <Run Text="站"/>
                                                                                                                <Run Text="{Binding StationNumber, StringFormat=D2}"/>
                                                                                                                <Run Text=" "/>
                                                                                                                <Run Text="{Binding ModuleType}"/>
                                                                                                            </ui:TextBlock>
                                                                                                            
                                                                                                            <!-- 从站通道列表（2列布局） -->
                                                                                                            <ItemsControl ItemsSource="{Binding FFSlaveChannels}">
                                                                                                                <ItemsControl.ItemsPanel>
                                                                                                                    <ItemsPanelTemplate>
                                                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                                                    </ItemsPanelTemplate>
                                                                                                                </ItemsControl.ItemsPanel>
                                                                                                                <ItemsControl.ItemTemplate>
                                                                                                                    <DataTemplate>
                                                                                                                        <Border Width="25" Height="14" Margin="0.5" BorderThickness="1" 
                                                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" 
                                                                                                                                Tag="{Binding}" 
                                                                                                                                Background="{Binding Point,Converter={StaticResource PointToBrushConverter}}">
                                                                                                                            <ui:TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7"
                                                                                                                                          Text="{Binding Index}">
                                                                                                                                <ui:TextBlock.Foreground>
                                                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                                                        <Binding Path="Point"/>
                                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                                                    </MultiBinding>
                                                                                                                                </ui:TextBlock.Foreground>
                                                                                                                            </ui:TextBlock>
                                                                                                                        </Border>
                                                                                                                    </DataTemplate>
                                                                                                                </ItemsControl.ItemTemplate>
                                                                                                            </ItemsControl>
                                                                                                        </StackPanel>
                                                                                                    </Border>
                                                                                                    </DataTemplate>
                                                                                                </ItemsControl.ItemTemplate>
                                                                                            </ItemsControl>
                                                                                        </StackPanel>
                                                                                    </Border>
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>
                                                                    </StackPanel>
                                                                    
                                                                    <!-- 通讯板卡显示（多端口结构） -->
                                                                    <StackPanel Visibility="{Binding Board.FFBoardType, Converter={StaticResource CommunicationBoardVisibilityConverter}}">
                                                                        <ItemsControl ItemsSource="{Binding Board.CommPorts}">
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <!-- 端口框：显示com0/com1等 -->
                                                                                    <Border Margin="3,2" BorderThickness="2" CornerRadius="3"
                                                                                            BorderBrush="{DynamicResource TextFillColorPrimaryBrush}">
                                                                                        <StackPanel>
                                                                                            <!-- 端口标题 -->
                                                                                            <ui:TextBlock Margin="3,2,3,1" FontSize="9" 
                                                                                                          Text="{Binding PortName}" 
                                                                                                          HorizontalAlignment="Center" 
                                                                                                          FontWeight="Bold"
                                                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                                            
                                                                                            <!-- 虚拟信号列表（使用方块显示，2列布局） -->
                                                                                            <ItemsControl ItemsSource="{Binding VirtualSignals}">
                                                                                                <ItemsControl.ItemsPanel>
                                                                                                    <ItemsPanelTemplate>
                                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                                    </ItemsPanelTemplate>
                                                                                                </ItemsControl.ItemsPanel>
                                                                                                <ItemsControl.ItemTemplate>
                                                                                                    <DataTemplate>
                                                                                                        <!-- 方块显示（类似普通板卡通道） -->
                                                                                                        <Border Width="14" Height="14" Margin="1" 
                                                                                                                BorderThickness="1" 
                                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" 
                                                                                                                Tag="{Binding}" 
                                                                                                                Background="{Binding Signal,Converter={StaticResource PointToBrushConverter}}">
                                                                                                            <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7">
                                                                                                                <ui:TextBlock.Foreground>
                                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                                        <Binding Path="Signal"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                                    </MultiBinding>
                                                                                                                </ui:TextBlock.Foreground>
                                                                                                            </ui:TextBlock>
                                                                                                        </Border>
                                                                                                    </DataTemplate>
                                                                                                </ItemsControl.ItemTemplate>
                                                                                            </ItemsControl>
                                                                                        </StackPanel>
                                                                                    </Border>
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>
                                                                    </StackPanel>
                                                                    
                                                                    <!-- 普通板卡显示 -->
                                                                    <ItemsControl ItemsSource="{Binding Board.Channels}" Visibility="{Binding Board.FFBoardType, Converter={StaticResource NormalBoardVisibilityConverter}}">
                                                                        <ItemsControl.ItemsPanel>
                                                                            <ItemsPanelTemplate>
                                                                                <WrapPanel Orientation="Horizontal"/>
                                                                            </ItemsPanelTemplate>
                                                                        </ItemsControl.ItemsPanel>
                                                                        <ItemsControl.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <Border Width="25" Height="14" Margin="3,0,0,3" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                              AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" Tag="{Binding}" Background="{Binding Point,Converter={StaticResource PointToBrushConverter}}">
                                                                                    <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold">
                                                                                        <ui:TextBlock.Foreground>
                                                                                            <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                <Binding Path="Point"/>
                                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                            </MultiBinding>
                                                                                        </ui:TextBlock.Foreground>
                                                                                    </ui:TextBlock>
                                                                                </Border>
                                                                            </DataTemplate>
                                                                        </ItemsControl.ItemTemplate>
                                                                    </ItemsControl>
                                                                </StackPanel>
                                                            </Border>
                                                        </Grid>
                                                    </Grid>

                                                </Border>

                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

        </Grid>

        <Border Grid.Row="1" Grid.Column="1" Grid.RowSpan="100" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" BorderThickness="1" Margin="3" Padding="0,0,3,0"
        Background="#01000000" AllowDrop="True" DragOver="UnsetBoardsDragOver" Drop="UnsetBoardsDrop">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <StackPanel Margin="10,5,0,0" Orientation="Horizontal">
                    <ui:TextBlock Text="虚拟插槽" VerticalAlignment="Center"/>
                    <ui:Button Margin="10,0,0,0" Icon="{ui:SymbolIcon Add24}" Height="23" Command="{Binding ViewModel.AddBoardToUnsetCommand}" IsEnabled="{Binding ViewModel.Cabinet, Converter={StaticResource NullToBooleanConverter}}"/>
                </StackPanel>
                <ScrollViewer Grid.Row="1" MaxWidth="200" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding ViewModel.Cabinet.VirtualSlots}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border BorderThickness="1" Margin="3,3,0,3" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" Tag="{Binding}">
                                    <Border.Background>
                                        <MultiBinding Converter="{StaticResource BoardBackgroundBrushConverter}">
                                            <Binding Path="Board"/>
                                            <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedBoard"/>
                                        </MultiBinding>
                                    </Border.Background>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="auto"/>
                                            <RowDefinition Height="auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>

                                        <!-- 虚拟插槽标题 -->
                                        <ui:TextBlock Grid.Row="0" Margin="3,3,0,0" Text="{Binding Index, StringFormat='虚拟插槽 {0}'}" FontWeight="Bold" FontSize="10"/>

                                        <!-- 板卡类型，根据FFBoardType显示不同标签 -->
                                        <StackPanel Grid.Row="1" Margin="3,1,0,0" Orientation="Horizontal" HorizontalAlignment="Center">
                                            <ui:TextBlock Text="{Binding Board.Type}" FontWeight="SemiBold"/>
                                            <!-- FF总线箱标签（仅在板卡存在时显示） -->
                                            <ui:TextBlock Text=" [总线]" FontSize="8" FontWeight="Bold" Foreground="#FF4A90E2">
                                                <ui:TextBlock.Style>
                                                    <Style TargetType="ui:TextBlock">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding Board, Converter={StaticResource NullToBoolConverter}}" Value="True"/>
                                                                    <Condition Binding="{Binding Board.FFBoardType, Converter={StaticResource FFBusVisibilityConverter}}" Value="Visible"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:TextBlock.Style>
                                            </ui:TextBlock>
                                            <!-- FF从站箱标签（仅在板卡存在时显示） -->
                                            <ui:TextBlock Text=" [从站]" FontSize="8" FontWeight="Bold" Foreground="#FFFF8C00">
                                                <ui:TextBlock.Style>
                                                    <Style TargetType="ui:TextBlock">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding Board, Converter={StaticResource NullToBoolConverter}}" Value="True"/>
                                                                    <Condition Binding="{Binding Board.FFBoardType, Converter={StaticResource FFSlaveVisibilityConverter}}" Value="Visible"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:TextBlock.Style>
                                            </ui:TextBlock>
                                        </StackPanel>

                                        <Grid Grid.Row="2" Margin="3">
                                            <!-- 只有当Board不为null时才显示板卡内容 -->
                                            <Border Width="61" VerticalAlignment="Stretch" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                            Visibility="{Binding Board, Converter={StaticResource NullToVisibilityConverter}}">
                                                <StackPanel>
                                                    <!-- 拖动按钮 -->
                                                    <Border Background="#01000000" MouseDown="BoardDragStart" Tag="{Binding Board}" Margin="3,1" Height="18" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}">
                                                        <ui:SymbolIcon Symbol="ArrowMove24"/>
                                                    </Border>
                                                    <!-- 查看按钮（所有板卡都显示） -->
                                                    <Border Background="#01000000" Margin="3,0,3,3" Height="18" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                      Cursor="Hand" MouseLeftButtonDown="ViewBoardClick" Tag="{Binding Board}">
                                                        <ui:SymbolIcon Symbol="Eye24"/>
                                                    </Border>
                                                    
                                                    <!-- FF总线板卡显示（双网段框结构） -->
                                                    <StackPanel Visibility="{Binding Board.FFBoardType, Converter={StaticResource FFBusVisibilityConverter}}">
                                                        <ItemsControl ItemsSource="{Binding Board.Networks}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <!-- 网段框：可点击查看网段信号（选中背景变红） -->
                                                                    <Border Margin="3,2" BorderThickness="2" CornerRadius="3"
                                                                            BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                            Cursor="Hand"
                                                                            MouseLeftButtonDown="NetworkBorder_Click"
                                                                            Tag="{Binding}">
                                                                        <Border.Background>
                                                                            <MultiBinding Converter="{StaticResource NetworkBackgroundBrushConverter}">
                                                                                <Binding/>
                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedNetwork"/>
                                                                            </MultiBinding>
                                                                        </Border.Background>
                                                                        <StackPanel>
                                                                            <!-- 网段标题 -->
                                                                            <ui:TextBlock Margin="3,2,3,1" FontSize="9" 
                                                                                          Text="{Binding NetworkType}" 
                                                                                          HorizontalAlignment="Center" 
                                                                                          FontWeight="Bold"
                                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                            
                                                                            <!-- 信号列表（使用圆点显示，2列布局） -->
                                                                            <ItemsControl ItemsSource="{Binding FFBusChannels}">
                                                                                <ItemsControl.ItemsPanel>
                                                                                    <ItemsPanelTemplate>
                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                    </ItemsPanelTemplate>
                                                                                </ItemsControl.ItemsPanel>
                                                                                <ItemsControl.ItemTemplate>
                                                                                    <DataTemplate>
                                                                                        <!-- 圆点显示 -->
                                                                                        <Border Width="14" Height="14" Margin="2" 
                                                                                                CornerRadius="7"
                                                                                                BorderThickness="1" 
                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" 
                                                                                                Tag="{Binding}" 
                                                                                                Background="{Binding Point,Converter={StaticResource PointToBrushConverter}}">
                                                                                            <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7">
                                                                                                <ui:TextBlock.Foreground>
                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                        <Binding Path="Point"/>
                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                    </MultiBinding>
                                                                                                </ui:TextBlock.Foreground>
                                                                                            </ui:TextBlock>
                                                                                        </Border>
                                                                                    </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                            </ItemsControl>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                    
                                                    <!-- FF从站板卡显示（双网段框结构） -->
                                                    <StackPanel Visibility="{Binding Board.FFBoardType, Converter={StaticResource FFSlaveVisibilityConverter}}">
                                                        <ItemsControl ItemsSource="{Binding Board.Networks}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <!-- 网段框：可点击选中（选中背景变红） -->
                                                                    <Border Margin="3,2" BorderThickness="2" CornerRadius="3"
                                                                            BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                            Cursor="Hand"
                                                                            MouseLeftButtonDown="NetworkBorder_Click"
                                                                            Tag="{Binding}">
                                                                        <Border.Background>
                                                                            <MultiBinding Converter="{StaticResource NetworkBackgroundBrushConverter}">
                                                                                <Binding/>
                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.SelectedNetwork"/>
                                                                            </MultiBinding>
                                                                        </Border.Background>
                                                                        <StackPanel>
                                                                            <!-- 网段标题 -->
                                                                            <ui:TextBlock Margin="3,2,3,1" FontSize="9" 
                                                                                          Text="{Binding NetworkType}" 
                                                                                          HorizontalAlignment="Center" 
                                                                                          FontWeight="Bold"
                                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                            
                                                                            <!-- 未分配信号列表（当没有模块时显示） -->
                                                                            <ItemsControl ItemsSource="{Binding UnallocatedSignals}">
                                                                                <ItemsControl.Style>
                                                                                    <Style TargetType="ItemsControl">
                                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                                        <Style.Triggers>
                                                                                            <!-- 当模块列表为空时显示未分配信号 -->
                                                                                            <DataTrigger Binding="{Binding Modules.Count}" Value="0">
                                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </ItemsControl.Style>
                                                                                <ItemsControl.ItemsPanel>
                                                                                    <ItemsPanelTemplate>
                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                    </ItemsPanelTemplate>
                                                                                </ItemsControl.ItemsPanel>
                                                                                <ItemsControl.ItemTemplate>
                                                                                    <DataTemplate>
                                                                                        <!-- 未分配信号方块（橙色边框提示） -->
                                                                                        <Border Width="25" Height="14" Margin="1" BorderThickness="1" 
                                                                                                BorderBrush="Orange"
                                                                                                Background="{Binding Converter={StaticResource PointToBrushConverter}}">
                                                                                            <ui:TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7"
                                                                                                          Text="0">
                                                                                                <ui:TextBlock.Foreground>
                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                        <Binding/>
                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                    </MultiBinding>
                                                                                                </ui:TextBlock.Foreground>
                                                                                            </ui:TextBlock>
                                                                                        </Border>
                                                                                    </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                            </ItemsControl>
                                                                            
                                                                            <!-- 模块列表 -->
                                                                            <ItemsControl ItemsSource="{Binding Modules}">
                                                                                <ItemsControl.ItemTemplate>
                                                                                    <DataTemplate>
                                                                                        <StackPanel Margin="2">
                                                                                            <!-- 模块标题：加粗、调整宽度 -->
                                                                                            <ui:TextBlock Margin="2,1" FontSize="8" FontWeight="Bold" HorizontalAlignment="Center" TextWrapping="Wrap" MaxWidth="55">
                                                                                                                <ui:TextBlock.Style>
                                                                                                                    <Style TargetType="ui:TextBlock">
                                                                                                                        <!-- 默认显示站号+型号 -->
                                                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                                                        <Style.Triggers>
                                                                                                                            <!-- BUS虚拟模块隐藏标题 -->
                                                                                                                            <DataTrigger Binding="{Binding ModuleType}" Value="BUS">
                                                                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                                                            </DataTrigger>
                                                                                                                            <!-- “未分配”模块显示“⚠ 待分配” -->
                                                                                                                            <DataTrigger Binding="{Binding ModuleType}" Value="未分配">
                                                                                                                                <Setter Property="Text" Value="⚠ 待分配"/>
                                                                                                                                <Setter Property="Foreground" Value="Orange"/>
                                                                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                                                                            </DataTrigger>
                                                                                                                        </Style.Triggers>
                                                                                                                    </Style>
                                                                                                </ui:TextBlock.Style>
                                                                                                <Run Text="站"/>
                                                                                                <Run Text="{Binding StationNumber, StringFormat=D2}"/>
                                                                                                <Run Text=" "/>
                                                                                                <Run Text="{Binding ModuleType}"/>
                                                                                            </ui:TextBlock>
                                                                                            
                                                                                            <!-- 从站通道列表（2列布局） -->
                                                                                            <ItemsControl ItemsSource="{Binding FFSlaveChannels}">
                                                                                                <ItemsControl.ItemsPanel>
                                                                                                    <ItemsPanelTemplate>
                                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                                    </ItemsPanelTemplate>
                                                                                                </ItemsControl.ItemsPanel>
                                                                                                <ItemsControl.ItemTemplate>
                                                                                                    <DataTemplate>
                                                                                                        <Border Width="25" Height="14" Margin="1" BorderThickness="1" 
                                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" 
                                                                                                                Tag="{Binding}" 
                                                                                                                Background="{Binding Point,Converter={StaticResource PointToBrushConverter}}">
                                                                                                            <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="8">
                                                                                                                <ui:TextBlock.Foreground>
                                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                                        <Binding Path="Point"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                                    </MultiBinding>
                                                                                                                </ui:TextBlock.Foreground>
                                                                                                            </ui:TextBlock>
                                                                                                        </Border>
                                                                                                    </DataTemplate>
                                                                                                </ItemsControl.ItemTemplate>
                                                                                            </ItemsControl>
                                                                                        </StackPanel>
                                                                                    </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                            </ItemsControl>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                    
                                                    <!-- 通讯板卡显示（多端口结构） -->
                                                    <StackPanel Visibility="{Binding Board.FFBoardType, Converter={StaticResource CommunicationBoardVisibilityConverter}}">
                                                        <ItemsControl ItemsSource="{Binding Board.CommPorts}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <!-- 端口框：显示com0/com1等 -->
                                                                    <Border Margin="3,2" BorderThickness="2" CornerRadius="3"
                                                                            BorderBrush="{DynamicResource TextFillColorPrimaryBrush}">
                                                                        <StackPanel>
                                                                            <!-- 端口标题 -->
                                                                            <ui:TextBlock Margin="3,2,3,1" FontSize="9" 
                                                                                          Text="{Binding PortName}" 
                                                                                          HorizontalAlignment="Center" 
                                                                                          FontWeight="Bold"
                                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                            
                                                                            <!-- 虚拟信号列表（使用方块显示，2列布局） -->
                                                                            <ItemsControl ItemsSource="{Binding VirtualSignals}">
                                                                                <ItemsControl.ItemsPanel>
                                                                                    <ItemsPanelTemplate>
                                                                                        <UniformGrid Columns="2" HorizontalAlignment="Center"/>
                                                                                    </ItemsPanelTemplate>
                                                                                </ItemsControl.ItemsPanel>
                                                                                <ItemsControl.ItemTemplate>
                                                                                    <DataTemplate>
                                                                                        <!-- 方块显示（类似普通板卡通道） -->
                                                                                        <Border Width="14" Height="14" Margin="1" 
                                                                                                BorderThickness="1" 
                                                                                                BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" 
                                                                                                Tag="{Binding}" 
                                                                                                Background="{Binding Signal,Converter={StaticResource PointToBrushConverter}}">
                                                                                            <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold" FontSize="7">
                                                                                                <ui:TextBlock.Foreground>
                                                                                                    <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                                        <Binding Path="Signal"/>
                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                                        <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                                                    </MultiBinding>
                                                                                                </ui:TextBlock.Foreground>
                                                                                            </ui:TextBlock>
                                                                                        </Border>
                                                                                    </DataTemplate>
                                                                                </ItemsControl.ItemTemplate>
                                                                            </ItemsControl>
                                                                        </StackPanel>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                    
                                                    <!-- 普通板卡显示 -->
                                                    <ItemsControl ItemsSource="{Binding Board.Channels}" Visibility="{Binding Board.FFBoardType, Converter={StaticResource NormalBoardVisibilityConverter}}">
                                                        <ItemsControl.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <WrapPanel Orientation="Horizontal"/>
                                                            </ItemsPanelTemplate>
                                                        </ItemsControl.ItemsPanel>
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Border Width="25" Height="14" Margin="3,1,0,1" BorderThickness="1" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}"
                                                                AllowDrop="True" DragOver="ChannelDragOver" Drop="ChannelDrop" Tag="{Binding}" Background="{Binding Point,Converter={StaticResource PointToBrushConverter}}">
                                                                    <ui:TextBlock Text="{Binding Index}" HorizontalAlignment="Center" VerticalAlignment="Center" FontWeight="Bold">
                                                                        <ui:TextBlock.Foreground>
                                                                            <MultiBinding Converter="{StaticResource ChannelForegroundValueConverter}">
                                                                                <Binding Path="Point"/>
                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.LocalBoxNumber1"/>
                                                                                <Binding RelativeSource="{RelativeSource AncestorType=local:CabinetAllocatedPage}" Path="ViewModel.PowerType1"/>
                                                                            </MultiBinding>
                                                                        </ui:TextBlock.Foreground>
                                                                    </ui:TextBlock>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <Border Grid.Row="1" Grid.Column="2" MaxHeight="284" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" BorderThickness="1" Margin="3" VerticalAlignment="Stretch" Padding="0,0,3,0">
            <Grid Background="#01000000" AllowDrop="True" DragOver="ViewDragOver" Drop="ViewDrop">
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <StackPanel Orientation="Horizontal" Margin="10,5,0,0"> 
                    <ui:TextBlock VerticalAlignment="Center" Text="查看卡件 ["/>
                    <ui:TextBlock VerticalAlignment="Center" Text="{Binding ViewModel.ViewBoard.Type}"/>
                    <ui:TextBlock VerticalAlignment="Center" Text="] 共 "/>
                    <ui:TextBlock VerticalAlignment="Center" Text="{Binding ViewModel.BoardPointCount}"/>
                    <ui:TextBlock VerticalAlignment="Center" Text=" 个"/>

                    <ui:TextBlock Margin="10,0,0,0" Text="就地箱号" VerticalAlignment="Center"/>
                    <ComboBox Margin="10,0,0,0" ItemsSource="{Binding ViewModel.LocalBoxNumberOptions}" SelectedItem="{Binding ViewModel.LocalBoxNumber2}" VerticalAlignment="Center" MinWidth="150"/>
                    <ui:TextBlock Margin="10,0,0,0" Text="供电类型" VerticalAlignment="Center"/>
                    <ComboBox Margin="10,0,0,0" ItemsSource="{Binding ViewModel.PowerTypeOptions}" SelectedItem="{Binding ViewModel.PowerType2}" VerticalAlignment="Center" MinWidth="150"/>
                </StackPanel>
                <cus:CustomDataGrid Name="Data1" Grid.Row="1" Margin="5" ItemsSource="{Binding ViewModel.DisplayBoardPoints}" RowHeight="24" FrozenColumnCount="2" AutoGenerateColumns="True" Style="{StaticResource DataGridStyle}" Loaded="DataGrid_Loaded" Unloaded="DataGrid_Unloaded">
                    <cus:CustomDataGrid.Columns>
                        <DataGridTemplateColumn Width="31">
                            <DataGridTemplateColumn.Header>
                                <CheckBox Checked="CheckBox_Checked" Unchecked="CheckBox_Unchecked" Margin="1" Tag="{Binding ElementName=Data1}"/>
                            </DataGridTemplateColumn.Header>
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <CheckBox Tag="{Binding}" HorizontalAlignment="Center"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="移动">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="#01000000" Height="24" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" MouseDown="PointDragStart" Tag="{Binding}">
                                        <ui:SymbolIcon Symbol="ArrowMove24" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                    </Border>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                    </cus:CustomDataGrid.Columns>
                </cus:CustomDataGrid>
            </Grid>
        </Border>

        <Border Grid.Row="2" Grid.Column="2" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" BorderThickness="1" Margin="3" VerticalAlignment="Stretch" Padding="0,0,3,0">
            <Grid Background="#01000000" AllowDrop="True" DragOver="UnsetPointsDragOver" Drop="UnsetPointsDrop">
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <StackPanel Orientation="Horizontal" Margin="10,5,0,0">
                    <ui:TextBlock VerticalAlignment="Center" Text="未分配点 共 "/>
                    <ui:TextBlock VerticalAlignment="Center" Text="{Binding ViewModel.UnsetPointCount}"/>
                    <ui:TextBlock VerticalAlignment="Center" Text=" 个"/>

                    <ui:TextBlock Margin="10,0,0,0" Text="就地箱号" VerticalAlignment="Center"/>
                    <ComboBox Margin="10,0,0,0" ItemsSource="{Binding ViewModel.LocalBoxNumberOptions}" SelectedItem="{Binding ViewModel.LocalBoxNumber3}" VerticalAlignment="Center" MinWidth="150"/>
                    <ui:TextBlock Margin="10,0,0,0" Text="供电类型" VerticalAlignment="Center"/>
                    <ComboBox Margin="10,0,0,0" ItemsSource="{Binding ViewModel.PowerTypeOptions}" SelectedItem="{Binding ViewModel.PowerType3}" VerticalAlignment="Center" MinWidth="150"/>
                </StackPanel>
                <cus:CustomDataGrid Name="Data2" Grid.Row="1" Margin="5" ItemsSource="{Binding ViewModel.DisplayUnsetPoints}" RowHeight="24" FrozenColumnCount="2" AutoGenerateColumns="True" Style="{StaticResource DataGridStyle}" Loaded="DataGrid_Loaded" Unloaded="DataGrid_Unloaded">
                    <cus:CustomDataGrid.Columns>
                        <DataGridTemplateColumn Width="31">
                            <DataGridTemplateColumn.Header>
                                <CheckBox Checked="CheckBox_Checked" Unchecked="CheckBox_Unchecked" Margin="1" Tag="{Binding ElementName=Data2}"/>
                            </DataGridTemplateColumn.Header>
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <CheckBox Tag="{Binding}" HorizontalAlignment="Center"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="移动">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="#01000000" Height="24" BorderBrush="{DynamicResource TextFillColorPrimaryBrush}" MouseDown="PointDragStart" Tag="{Binding}">
                                        <ui:SymbolIcon Symbol="ArrowMove24" VerticalAlignment="Top" Margin="0,5,0,0"/>
                                    </Border>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                    </cus:CustomDataGrid.Columns>
                </cus:CustomDataGrid>
            </Grid>
        </Border>

    </Grid>
    
   
</Page>
