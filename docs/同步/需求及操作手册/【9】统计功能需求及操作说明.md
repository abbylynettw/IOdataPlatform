# 统计功能需求及操作说明

## 一、需求文档

### 功能目标
我需要一个功能，能够实时统计IO清单的各项数据，包括总点数、备用点数、报警点数、普通点数、未分配点数、空板卡数、各卡型号的冗余率等。统计结果要分机柜显示，也要有全局汇总。统计要能够自动更新，也可以手动刷新。

### 统计范围
系统提供两个层级的统计：
1. **全局统计**：整个项目所有机柜的汇总数据
2. **机柜统计**：每个机柜的独立统计数据

### 1. 统计指标说明

#### 总点数（TotalPoints）
- 定义：所有已分配到板卡通道的信号数量
- 计算规则：遍历所有机柜→所有机笼→所有插槽→所有板卡→所有通道，统计Point不为null的数量
- 包含：普通信号、报警信号、备用点、通讯报警点等所有类型
- 不包含：未分配信号

#### 备用点数（BackupPoints）
- 定义：信号类型为BackUp的点数
- 计算规则：筛选PointType == TagType.BackUp的信号数量
- 用途：统计预留的扩展通道

#### 报警点数（AlarmPoints）
- 定义：报警类型的信号数量
- 分类：
  - 通讯报警点（CommunicationAlarm）：分配到预留板卡的报警
  - 硬点报警点（Alarm）：普通硬接线报警
- 计算规则：筛选PointType == TagType.Alarm 或 PointType == TagType.CommunicationAlarm

#### 普通点数（NormalPoints）
- 定义：信号类型为Normal的点数
- 计算规则：筛选PointType == TagType.Normal的信号数量
- 包含：AI、AO、DI、DO、PI等所有常规IO信号

#### 未分配点数（UnsetPoints）
- 定义：未成功分配到板卡的信号数量
- 计算规则：统计机柜结构中UnsetPoints集合的数量
- 原因：板卡容量不足、配置缺失、分配失败等

#### 空板卡数（UnsetBoards）
- 定义：已安装但没有分配任何信号的板卡数量
- 计算规则：遍历所有插槽，统计所有通道Point都为null的板卡
- 用途：发现资源浪费或配置错误

#### 冗余率（RedundancyRates）
- 定义：每种卡型号的空闲通道占比
- 计算公式：`冗余率 = (空闲通道数 / 总通道数) × 100%`
- 按卡型号分组统计
- 用途：评估板卡利用率和扩展空间

### 2. 统计数据结构

#### 全局统计信息（TotalSummaryInfo）
```
{
    TotalPoints: { Number: 总数, Illegal: 是否合法 },
    BackupPoints: { Number: 总数, Illegal: 是否合法 },
    AlarmPoints: { Number: 总数, Illegal: 是否合法 },
    NormalPoints: { Number: 总数, Illegal: 是否合法 },
    UnsetPoints: { Number: 总数, Illegal: 是否合法 },
    UnsetBoards: { Number: 总数, Illegal: 是否合法 },
    RedundancyRates: [
        { CardType: "AI201", Rate: 15.2 },
        { CardType: "DI211", Rate: 22.5 },
        ...
    ]
}
```

#### 机柜统计信息（CabinetSummaryInfo）
```
{
    CabinetName: "3ACKC001AR",
    TotalPoints: 156,
    BackupPoints: 42,
    AlarmPoints: 8,
    CommunicationAlarmCount: 5,
    HardwareAlarmCount: 3,
    NormalPoints: 106,
    UnsetPoints: 0,
    UnsetBoards: 0,
    RedundancyRates: [
        { CardType: "AI201", Rate: 12.5 },
        { CardType: "DI211", Rate: 18.7 }
    ]
}
```

### 3. 统计计算规则

#### 从IO清单数据计算
适用于XT1、龙核、安全级等系统：
1. 将IO清单数据转换为机柜结构（BuildCabinetStructure）
2. 遍历机柜结构统计各项指标
3. 按卡型号分组统计冗余率

#### 从机柜结构计算
适用于XT2系统（已有机柜结构）：
1. 直接遍历机柜结构
2. 统计各项指标
3. 按卡型号分组统计冗余率

### 4. 冗余率计算详解

#### 计算步骤
1. 遍历所有机柜的所有机笼的所有插槽
2. 筛选出已安装板卡的插槽（Board != null）
3. 按卡型号分组
4. 统计每组的：
   - 总通道数 = Σ(每块板卡的通道数)
   - 空闲通道数 = Σ(每块板卡Point为null的通道数)
5. 计算冗余率 = (空闲通道数 / 总通道数) × 100%
6. 保留1位小数

#### 示例
```
AI201板卡统计：
- 板卡1：16通道，已用10，空闲6
- 板卡2：16通道，已用12，空闲4
- 板卡3：16通道，已用14，空闲2

总通道数：16 × 3 = 48
空闲通道数：6 + 4 + 2 = 12
冗余率：(12 / 48) × 100% = 25.0%
```

### 5. 统计触发时机

#### 自动触发
- IO分配完成后
- 添加/删除报警点后
- 添加/删除备用点后
- 数据重新计算后
- 机柜预览界面初始化时

#### 手动触发
- 点击"刷新统计"按钮
- 统计数据页面加载时
- 数据修改后需要更新统计时

### 6. 统计结果展示

#### 机柜卡片展示
每个机柜显示一张卡片，包含：
- 机柜名称
- 总点数
- 普通点数
- 报警点数（区分通讯/硬点）
- 备用点数
- 未分配点数
- 空板卡数
- 冗余率列表（按卡型号）

#### 全局汇总展示
显示所有机柜的合计数据：
- 总机柜数
- 总点数汇总
- 各类型点数汇总
- 整体冗余率（按卡型号）

### 7. 统计报表

#### 控制台日志
记录统计过程：
```
[10:30:15] 📊 开始刷新统计信息...
[10:30:15] 🔍 正在统计机柜: 3ACKC001AR
[10:30:15]   - 总点数: 156
[10:30:15]   - 普通点: 106
[10:30:15]   - 报警点: 8 (通讯: 5, 硬点: 3)
[10:30:15]   - 备用点: 42
[10:30:15] 🔍 正在统计机柜: 3ACKC002AR
...
[10:30:16] ✅ 统计完成！
[10:30:16] 📊 已加载 15 个机柜的详细统计信息
```

#### 统计摘要
```
总计：
  - 机柜数量: 15
  - 总点数: 2340
  - 普通点: 1890
  - 报警点: 120
  - 备用点: 330
  - 未分配: 0
  - 空板卡: 0

冗余率：
  - AI201: 15.2%
  - DI211: 22.5%
  - DO211: 18.7%
  - AO201: 12.3%
```

---

## 二、用户手册

### 操作步骤

#### 查看全局统计

**方式1：在统计页面查看**
1. 进入"机柜报警管理"或"点位详细管理"页面
2. 系统自动加载统计数据
3. 查看每个机柜的统计卡片
4. 查看全局汇总数据

**方式2：在预览页面查看**
1. 执行IO分配后，查看分配预览
2. 预览页面显示统计摘要
3. 包含总点数、各类型点数等

#### 刷新统计数据

**手动刷新**
1. 点击"刷新统计"按钮（🔄图标）
2. 系统重新计算所有统计数据
3. 更新界面显示
4. 查看控制台日志了解详情

**自动刷新**
- 执行IO分配后自动刷新
- 添加/删除报警点后自动刷新
- 添加/删除备用点后自动刷新

#### 查看机柜详细统计

**在卡片中查看**
1. 找到目标机柜的卡片
2. 查看各项统计指标：
   - 总点数（所有信号）
   - 普通点（常规IO信号）
   - 通讯报警（预留板卡报警）
   - 硬点报警（硬接线报警）
   - 备用点（预留通道）
   - 未分配点（分配失败的信号）
   - 空板卡（未使用的板卡）
3. 查看冗余率列表（每种卡型号的利用率）

#### 查看冗余率

**理解冗余率**
- 冗余率 = 空闲通道 / 总通道 × 100%
- 冗余率越高，可扩展空间越大
- 冗余率过低，可能需要增加板卡

**查看方式**
1. 在机柜卡片中查看该机柜的冗余率
2. 在全局统计中查看所有机柜的平均冗余率
3. 按卡型号分组显示

### 统计指标说明

#### 总点数
- 含义：已分配到板卡的所有信号
- 包括：普通点、报警点、备用点等
- 不包括：未分配点

#### 普通点数
- 含义：常规IO信号（AI、AO、DI、DO、PI等）
- 不包括：报警点、备用点

#### 报警点数
- 通讯报警：分配到预留板卡的报警信号
- 硬点报警：普通硬接线报警信号
- 合计：两种报警的总和

#### 备用点数
- 含义：预留的扩展通道
- 用途：系统扩展、维护备用
- 可删除：不影响正常功能

#### 未分配点数
- 含义：未成功分配到板卡的信号
- 原因：板卡容量不足、配置缺失等
- 需处理：手动分配或调整配置

#### 空板卡数
- 含义：已安装但未分配任何信号的板卡
- 可能原因：配置错误、预留板卡等
- 需检查：避免资源浪费

### 使用场景

**场景1：评估分配结果**
- IO分配完成后查看统计
- 检查是否有未分配点
- 评估板卡利用率

**场景2：规划系统扩展**
- 查看各卡型号的冗余率
- 评估扩展空间
- 决定是否需要增加板卡

**场景3：资源优化**
- 找出空板卡
- 找出利用率过低的板卡
- 优化板卡配置

**场景4：问题排查**
- 查看未分配点数量和原因
- 定位分配失败的信号
- 调整配置后重新分配

### 注意事项

1. **统计数据实时性**：统计数据基于当前IO清单，数据修改后需手动刷新

2. **冗余率不包括备用点**：冗余率计算的空闲通道不包括已分配备用点的通道

3. **DP和FF板卡**：特殊板卡的冗余率计算可能不准确，需特别注意

4. **未分配点原因**：统计显示数量，具体原因需查看分配报告或机柜预览

5. **空板卡检查**：空板卡可能是预留板卡（正常）或配置错误（需修正）

6. **报警点分类**：注意区分通讯报警和硬点报警，两者分配方式不同

7. **统计性能**：数据量大时统计可能较慢，耐心等待或减少统计频率

8. **数据一致性**：确保IO清单数据已保存，未保存的修改不会反映在统计中

### 常见问题

**问题1：统计数据不准确**
- 原因：数据未刷新或未保存
- 解决：点击"刷新统计"按钮，确保数据已保存

**问题2：冗余率为0**
- 原因：该卡型号的所有通道都已占用
- 解决：增加该类型板卡，或删除不必要的信号

**问题3：冗余率为100%**
- 原因：该卡型号的板卡没有分配任何信号（空板卡）
- 解决：检查是否配置错误，或删除多余板卡

**问题4：未分配点数很多**
- 原因：IO分配失败，板卡容量不足或配置缺失
- 解决：查看分配报告，增加板卡或补充配置

**问题5：空板卡数不为0**
- 原因：有板卡安装了但没分配信号
- 解决：检查是否是预留板卡；如果不是，删除或重新分配

**问题6：备用点数量异常多**
- 原因：添加备用点后占用了大量空闲通道
- 解决：根据需要决定是否删除部分备用点

**问题7：报警点统计不对**
- 原因：报警点类型标记错误
- 解决：检查信号的PointType字段，确保正确标记

**问题8：总点数和各类型点数加起来不相等**
- 原因：可能有其他特殊类型的信号
- 解决：检查是否有预留信号等特殊类型

**问题9：刷新统计很慢**
- 原因：数据量大，统计计算复杂
- 解决：耐心等待，或优化数据结构

**问题10：不同页面统计数据不一致**
- 原因：数据修改后部分页面未刷新
- 解决：手动刷新所有相关页面，确保数据同步
