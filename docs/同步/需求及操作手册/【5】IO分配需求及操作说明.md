# IO分配需求及操作说明

## 一、需求文档

### 功能目标
我需要一个功能，能够将IO清单中的所有信号自动分配到机柜的板卡通道上。不同的信号需要使用不同类型的板卡，系统要自动判断用哪种板卡、放在哪个机笼哪个插槽、占用哪个通道。分配时要考虑供电兼容性、预留冗余通道、优先复用已有板卡等规则。

### 触发时机
点击"IO分配"按钮后，如果有机柜则先弹出预留槽位配置窗口，配置完成后自动执行IO分配。

### 前置条件
- 必须已完成"重新计算"，所有信号的卡型号、供电类型等字段已填充
- 必须已配置机柜清单（机柜名称、机笼数量、每笼槽位数等）
- 系统配置表（config_card_type_judge）中必须有对应板卡的配置信息
- 如果有预留槽位需求，需先配置预留槽位

### 1. 分配前处理

#### 清理旧分配结果
- 清空所有信号的机柜号、机笼号、插槽号、通道号等分配字段
- 将所有信号标记为"未分配"状态
- 重新初始化机柜结构（根据机柜清单重建机笼和插槽）

#### 处理预留槽位
如果配置了预留槽位：
- 在最后一个机笼从后往前预留指定数量的插槽
- 为每个预留插槽创建虚拟信号（标记为预留板卡）
- 虚拟信号占用对应的插槽位置，防止实际信号分配到这些位置
- 预留信号包含板卡类型（MD211/MD216/DP211）和预留目的（通讯/报警）信息

### 2. 信号分类规则

系统会将所有信号按以下类型分类：

#### 普通硬接线信号
- 识别规则：通讯方式为空或非总线通讯，且没有就地箱号
- 典型场景：机柜附近的传感器、执行器、就地仪表等

#### A类阀箱信号
- 识别规则：通讯方式为硬接线，但有就地箱号
- 典型场景：远程阀门控制箱、就地控制柜等

#### B类阀箱信号
- 识别规则：通讯方式为PROFIBUS
- 典型场景：PROFIBUS现场总线设备、远程IO模块等

#### FF总线信号
- 识别规则：通讯方式为FF或Fieldbus
- 分为两种：
  - FF总线箱：FF通讯但没有从站模块型号
  - FF从站箱：FF通讯且有从站模块型号（需要分配到模块）

#### 报警信号
- 识别规则：信号类型标记为"报警"
- 典型场景：各种报警指示、故障信号等

### 3. 分配优先级

对于同一类型的信号，按以下顺序优先处理：
1. AI（模拟量输入）- 温度、压力、流量等测量信号
2. PI（脉冲输入）- 计数、频率信号
3. AO（模拟量输出）- 阀门开度、变频器控制等
4. DI（数字量输入）- 开关状态、限位信号等
5. DO（数字量输出）- 电机启停、阀门开关等

### 4. 分配规则详解

#### 普通硬接线信号分配规则
- 按IO类型分组（AI、AO、DI、DO、PI）
- 同一IO类型再按卡型号分组
- 同一卡型号再按供电类型分组（只有供电类型兼容的信号才能共用板卡）
- 优先尝试复用已有板卡的空闲通道（需考虑冗余率）
- 如果已有板卡通道不够，安装新板卡
- 新板卡放在第一个有空闲插槽的机笼中

#### A类阀箱信号分配规则
- 按就地箱号分组
- 同一箱号的信号优先分配到同一块板卡
- 如果箱号的备注中有"串联"关键词，识别串联关系
- 串联的箱号会尝试分配到同一块板卡或相邻插槽
- 优先复用已有相同箱号的板卡
- 需要检查供电类型兼容性

#### B类阀箱信号分配规则
- 按就地箱号分组
- 识别备注中的串联关系（如"与XX串联"）
- 串联的箱号分配到同一块板卡
- 每个板卡可以对应多个箱号
- PROFIBUS板卡独立处理，不与其他类型混用

#### FF总线信号分配规则（最复杂）

**FF总线箱（无从站模块）：**
- 按就地箱号分组
- FF板卡有两个网段：Net1（前半通道）和Net2（后半通道）
- 优先分配到Net1
- 如果Net1通道不够或Net2有该箱号的串联设备，分配到Net2
- 识别备注中的串联关系，串联箱号尽量分配到同一网段
- 每个网段独立计算可用通道数和冗余率

**FF从站箱（有从站模块）：**
- 按就地箱号分组
- 再按设备前缀分组（相同设备的信号要放一起）
- 根据信号的IO类型和从站模块型号匹配对应的从站模块配置
- 为每个设备分配站号（从01开始递增）
- 同一设备的多个信号分配到同一从站模块的不同通道
- 从站模块也有Net1和Net2两个网段
- 优先分配到Net1，Net1满了再用Net2

#### 报警信号分配规则
- 按卡型号分组
- 如果机柜还有空闲插槽，优先安装新的报警板卡（独立管理）
- 如果插槽已满，尝试复用已有板卡的空闲通道
- 复用时需要检查供电类型兼容性
- 如果所有板卡通道都已占满，标记为"未分配"

### 5. 供电兼容性规则

不同供电方式的信号不能随意混用，必须按以下分组：

**数字量输入（DI）：**
- 第1组：DI1、DI6（24VDC供电）
- 第2组：DI2、DI3、DI4、DI5（其他供电方式）

**数字量输出（DO）：**
- 第3组：DO1、DO2（继电器输出）
- 第4组：DO3（晶体管输出）
- 第5组：DO4（可控硅输出）
- 第6组：DO5（其他输出）

**模拟量输入（AI）：**
- 第7组：AI1、AI6（4-20mA供电）
- 第8组：AI2、AI3、AI4、AI5（热电阻/热电偶）
- 第9组：AI7、AI8、AI9（其他信号）

**脉冲输入（PI）：**
- 第10组：P1、P2、P3（脉冲信号）

**模拟量输出（AO）：**
- 第11组：AO1（4-20mA输出）
- 第12组：AOH（HART协议）
- 第13组：AO2（其他输出）

只有在同一分组内的信号才能共用一块板卡。

### 6. 冗余率计算规则

为确保系统可靠性，每块板卡要预留一定比例的空闲通道：

**计算公式：**
```
预留通道数 = 总通道数 × 冗余率（向上取整）
可用通道数 = 总通道数 - 预留通道数 - 已使用通道数
```

**示例：**
- 一块AI板卡有16个通道，冗余率设为10%
- 预留通道：16 × 10% = 1.6，向上取整为2个
- 如果已使用10个通道，剩余可用：16 - 2 - 10 = 4个
- 此时如果有5个新信号需要分配，则需要安装新板卡

### 7. 分配结果

分配完成后，每个信号会填充以下字段：
- 机柜号：信号所属的机柜名称
- 机笼号：机柜中的第几个机笼
- 插槽号：机笼中的第几个插槽
- 通道号：板卡中的第几个通道
- 网段类型：FF板卡的网段（Net1/Net2），普通板卡为空
- 站号：FF从站信号的站号
- 模块类型：FF从站信号对应的从站模块型号

### 8. 未分配信号处理

如果有信号未能分配，会记录在"未分配信号列表"中，包含未分配原因：
- "未找到IO卡型号为：XXX的板卡配置" - 配置表缺失
- "供电类型有空值，无法分配" - 数据不完整
- "通道容量不足" - 板卡通道已满
- "机柜插槽已满" - 所有插槽都已占用

### 9. 分配报告

分配完成后会生成详细的分配报告，包括：
- 分配开始时间
- 冗余率设置
- 预留插槽统计
- 信号分类统计（硬接线、A类阀箱、B类阀箱、FF总线、报警）
- 每类信号的分配过程（按卡型号、供电类型分组）
- 每个箱号的信号数量和分配情况
- FF从站的模块分配详情
- 未分配信号统计及原因

---

## 二、用户手册

### 操作步骤

#### 第一步：准备工作
1. 确认已完成"导入原始数据"或手动录入IO数据
2. 确认已完成"重新计算"，所有信号的卡型号、供电类型已填充
3. 确认机柜清单已配置（机柜名称、机笼数、每笼槽位数）
4. 设置合适的冗余率（建议10%-20%）

#### 第二步：配置预留槽位（可选）
1. 点击"IO分配"按钮
2. 系统自动弹出"预留插槽配置"窗口
3. 勾选需要预留的机柜
4. 添加预留插槽，选择板卡类型和预留目的
5. 点击"确定并继续IO分配"

#### 第三步：执行自动分配
1. 系统自动开始分配，显示"正在分配..."进度
2. 分配过程包括：
   - 清理旧分配结果
   - 处理预留槽位
   - 分配硬接线信号
   - 分配A类阀箱信号
   - 分配B类阀箱信号
   - 分配FF总线信号
   - 分配报警信号
3. 等待分配完成

#### 第四步：查看分配报告
1. 分配完成后自动弹出分配报告窗口
2. 查看各类信号的分配统计
3. 查看未分配信号列表（如果有）
4. 根据报告调整配置或手动处理

#### 第五步：验证结果
1. 在IO清单中检查机柜号、机笼号、插槽号、通道号是否已填充
2. 抽查几条信号，确认分配合理
3. 如有未分配信号，根据原因进行处理

### 注意事项

1. **分配前必须重新计算**：如果IO清单修改过，必须先执行"重新计算"更新卡型号等字段，否则分配会失败

2. **冗余率建议值**：
   - 关键系统（安全相关）：20%-30%
   - 一般系统（正常生产）：10%-15%
   - 测试环境：5%-10%

3. **预留槽位注意**：预留槽位会占用实际插槽，减少可用插槽数量，预留太多可能导致插槽不够用

4. **配置表要完整**：如果提示"未找到IO卡型号"，需要在"数据资产中心"-"IO卡型号配置表"中添加对应板卡配置

5. **供电类型要准确**：供电类型错误会导致信号分配到不兼容的板卡，影响系统安全

6. **机柜清单要合理**：机笼数量、每笼槽位数要根据实际硬件配置，设置过小会导致插槽不够

7. **FF从站需要模块配置**：FF从站信号需要在配置表中配置从站模块型号对应关系，否则无法分配

8. **分配不可逆**：分配会清空旧的分配结果，建议分配前备份数据（系统会自动保存历史版本）

### 常见问题

**问题1：提示"未在IO卡型号配置表中找到IO卡型号为：XXX"**
- 原因：系统配置表缺少该卡型号的配置
- 解决：在"数据资产中心"-"IO卡型号配置表"中添加该卡型号，填写通道数、支持的IO类型等信息

**问题2：提示"供电类型有空值，无法分配"**
- 原因：某些信号的供电类型字段为空
- 解决：先执行"重新计算"更新供电类型；或手动补充缺失的供电类型

**问题3：分配完成后有很多未分配信号**
- 原因：板卡配置缺失、通道容量不足、供电类型不兼容等
- 解决：查看分配报告的未分配原因，针对性处理（补充配置、增加机柜、调整信号等）

**问题4：同一设备的信号被分配到不同板卡**
- 原因：供电类型不同、板卡通道不够、设备前缀识别错误等
- 解决：检查信号位号命名是否规范；手动调整分配结果；或修改供电类型后重新分配

**问题5：FF从站信号未分配**
- 原因：缺少从站模块配置、模块型号不匹配等
- 解决：在配置表中补充从站模块型号与板卡的对应关系

**问题6：报警信号全部未分配**
- 原因：机柜插槽已满，且已有板卡通道也已满
- 解决：增加机柜或机笼；或删除部分非必要信号腾出空间

**问题7：分配速度很慢**
- 原因：信号数量太多（几千条以上）、FF从站模块分配复杂等
- 解决：耐心等待，系统会显示进度提示；或分批处理信号

**问题8：预留槽位后插槽不够用**
- 原因：预留槽位太多，占用了实际需要的插槽
- 解决：减少预留槽位数量；或增加机笼数量

**问题9：A类阀箱信号分散在多个板卡**
- 原因：同一箱号的信号供电类型不同，无法共用板卡
- 解决：检查该箱号信号的供电类型是否合理；或接受分散分配（实际硬件允许的情况下）

**问题10：分配报告看不懂**
- 原因：报告内容较专业，包含技术细节
- 解决：重点关注"未分配信号"部分和各类信号的数量统计；技术细节可咨询系统管理员
