# 添加报警点需求及操作说明

## 一、需求文档

### 功能目标
我需要一个功能，能够批量为机柜添加报警点。机柜有多种报警类型（如电源故障、门开、温度高、风扇故障等），每种报警需要生成对应的DI信号。系统要自动根据Excel表格中的机柜报警配置，生成所有报警点，并可以选择分配方式（通讯报警或硬点报警）。

### 触发时机
在IO清单页面，点击"添加报警点"按钮，或在机柜预览页面点击某个机柜的"添加报警点"按钮。

### 前置条件
- 必须已完成机柜配置（机柜清单已创建）
- 需要准备包含机柜报警信息的Excel文件
- Excel文件必须包含必需的列（机柜名称、各报警类型数量等）

### 1. 报警类型分类

系统支持两种报警类型：

#### 通讯报警点
- 定义：分配到预留板卡的通讯报警模块
- 用途：用于机柜通讯报警、系统故障指示等
- 分配方式：自动分配到已预留的通讯报警板卡
- 典型场景：机柜电源故障、网络故障、综合故障等

#### 硬点报警点
- 定义：可选择分配到现有板卡或放入未分配列表
- 用途：普通硬接线报警信号
- 分配方式：可选择自动分配或手动分配
- 典型场景：机柜门开、温度高、风扇故障等

### 2. Excel表格格式要求

#### 必需列
Excel表格必须包含以下列（列名必须完全匹配）：

| 列名 | 说明 | 示例 |
|:-----|:-----|:-----|
| 机柜名称 | 机柜的唯一标识 | 3ACKC001AR |
| 机柜类型 | 机柜的类型描述 | DCS机柜 |
| 机柜电源A故障 | 电源A故障报警数量 | 1 |
| 机柜电源B故障 | 电源B故障报警数量 | 1 |
| 机柜门开 | 门开报警数量 | 1 |
| 温度高报警 | 温度高报警数量 | 1 |
| 风扇故障 | 风扇故障报警数量 | 1 |
| 网络故障 | 网络故障报警数量 | 1 |
| 温度 | 温度测量信号数量 | 1 |
| 综合故障 | 综合故障报警数量 | 1 |
| RTU板卡所在机柜号 | RTU板卡所在机柜 | 3ACKC001AR |
| RTU板卡位置 | RTU板卡的机笼-插槽 | 1-01 |
| 机柜RTU端子板号 | RTU端子板编号 | TB01 |

#### 数据格式
- 机柜名称：字符串，不能为空
- 报警数量：整数，0表示不生成该类型报警，大于0则生成对应数量的信号
- RTU信息：字符串，用于关联RTU板卡位置

### 3. 信号命名规则

根据报警类型和数量自动生成信号位号：

#### 命名格式
```
{机柜名称}_{报警类型缩写}{序号}
```

#### 报警类型缩写对照表

| 报警类型 | 缩写 | 示例位号 |
|:---------|:-----|:---------|
| 机柜电源A故障 | PWFA | 3ACKC001AR_PWFA1 |
| 机柜电源B故障 | PWFB | 3ACKC001AR_PWFB1 |
| 机柜门开 | DOOR | 3ACKC001AR_DOOR1 |
| 温度高报警 | TEMP | 3ACKC001AR_TEMP1 |
| 风扇故障 | FAN | 3ACKC001AR_FAN1 |
| 网络故障 | NET | 3ACKC001AR_NET1 |
| 温度 | TMP | 3ACKC001AR_TMP1（AI类型） |
| 综合故障 | FAULT | 3ACKC001AR_FAULT1 |

#### 序号规则
- 如果数量为1，序号为1
- 如果数量大于1，序号从1开始递增（如PWFA1、PWFA2、PWFA3）
- 序号保证同一机柜同一类型的信号位号唯一

### 4. 信号属性填充规则

每个生成的报警信号会自动填充以下字段：

#### 基础信息
- **信号位号**：按命名规则自动生成
- **信号描述**：{机柜名称} {报警类型中文名}
- **IO类型**：
  - 温度信号 → AI
  - 其他报警 → DI
- **信号类型**：报警（TagType.Alarm）

#### 卡型号和供电
- **卡型号**：根据IO类型从配置表自动匹配
- **供电类型**：
  - DI信号 → DI1（24VDC供电）
  - AI信号 → AI1（4-20mA）

#### RTU关联信息
- **关联机柜**：机柜名称
- **RTU板卡位置**：{RTU板卡所在机柜号}-{RTU板卡位置}
- **RTU端子板号**：机柜RTU端子板号

#### 其他字段
- **创建时间**：当前时间
- **子项目ID**：当前子项目
- **通讯方式**：硬接线
- **点类型**：根据报警类型选择（通讯报警/硬点报警）

### 5. 分配规则

#### 通讯报警点分配
选择"通讯报警"类型后：
- 自动查找已预留的通讯报警板卡
- 按顺序分配到预留板卡的空闲通道
- 如果预留板卡通道不够，标记为未分配
- 分配后更新机柜号、机笼号、插槽号、通道号

#### 硬点报警点分配
选择"硬点报警"类型后：
- 可以选择自动分配到现有DI板卡的空闲通道
- 或者放入未分配列表，后续手动分配
- 优先复用已有DI板卡，通道不够时安装新板卡

### 6. 数据校验规则

导入Excel后会进行校验：

#### 必需列检查
- 检查是否包含所有必需列
- 缺少列会提示具体缺失哪些列

#### 数据有效性检查
- 机柜名称不能为空
- 报警数量必须是非负整数
- RTU板卡位置格式必须为"机笼号-插槽号"（如"1-01"）

#### 重复性检查
- 同一机柜不能重复添加相同的报警点
- 检查信号位号是否与现有数据冲突

### 7. 操作流程

系统采用3步向导式流程：

#### 步骤1：选择Excel
- 选择包含机柜报警信息的Excel文件
- 选择工作表（如果有多个）
- 加载预览，查看表格数据

#### 步骤2：校验数据
- 自动校验Excel数据格式和完整性
- 显示校验结果（成功/失败/缺失列）
- 选择报警类型（通讯报警/硬点报警）

#### 步骤3：生成预览
- 显示即将生成的所有报警点
- 显示每个信号的位号、描述、分配状态
- 确认后完成添加

### 8. 生成结果

添加完成后：
- 将所有生成的报警点插入到IO清单数据库
- 如果选择自动分配，会更新分配信息
- 刷新IO清单显示
- 显示成功提示，并提供"立即预览"选项

---

## 二、用户手册

### 操作步骤

#### 第一步：准备Excel文件
1. 准备包含机柜报警信息的Excel表格
2. 确保包含所有必需列（参考上面的必需列表）
3. 填写每个机柜的报警类型数量（0表示不生成）
4. 保存Excel文件

#### 第二步：启动添加报警点功能
有两种启动方式：

**方式1：全局添加**
- 在IO清单页面点击"添加报警点"按钮
- 为所有机柜批量添加报警点

**方式2：单机柜添加**
- 在机柜预览页面选择某个机柜
- 点击该机柜的"添加报警点"按钮
- 只为该机柜添加报警点

#### 第三步：选择Excel文件（步骤1/3）
1. 点击"浏览"按钮
2. 选择准备好的Excel文件
3. 系统自动读取工作表列表
4. 选择包含数据的工作表
5. 点击"加载预览"查看数据是否正确
6. 确认无误后，点击"下一步"

#### 第四步：校验数据（步骤2/3）
1. 系统自动校验数据格式
2. 查看校验结果：
   - ✅ 成功：显示读取的机柜数量
   - ❌ 失败：显示具体错误原因
3. 选择报警类型：
   - 📡 通讯报警：分配到预留板卡
   - 🔌 硬点报警：可选分配方式
4. 点击"下一步"

#### 第五步：生成预览（步骤3/3）
1. 查看即将生成的所有报警点
2. 检查信号位号命名是否正确
3. 检查信号描述是否准确
4. 查看分配状态（已分配/未分配）
5. 查看分配位置（机柜-机笼-插槽-通道）
6. 确认无误后，点击"完成"

#### 第六步：查看结果
1. 系统显示"报警点添加完成！"
2. 点击"立即预览"查看机柜分配情况
3. 在IO清单中可以看到新添加的报警点
4. 检查报警点的分配是否正确

### Excel表格示例

**示例1：单机柜多种报警**
```
机柜名称        | 机柜电源A故障 | 机柜电源B故障 | 机柜门开 | 温度高报警 | 风扇故障 | 网络故障 | 温度 | 综合故障
3ACKC001AR     | 1            | 1            | 1       | 1         | 2       | 1       | 1   | 1
```
生成信号：
- 3ACKC001AR_PWFA1（电源A故障）
- 3ACKC001AR_PWFB1（电源B故障）
- 3ACKC001AR_DOOR1（门开）
- 3ACKC001AR_TEMP1（温度高报警）
- 3ACKC001AR_FAN1（风扇故障1）
- 3ACKC001AR_FAN2（风扇故障2）
- 3ACKC001AR_NET1（网络故障）
- 3ACKC001AR_TMP1（温度，AI类型）
- 3ACKC001AR_FAULT1（综合故障）

**示例2：多机柜批量添加**
```
机柜名称        | 机柜电源A故障 | 机柜电源B故障 | 机柜门开 | ...
3ACKC001AR     | 1            | 1            | 1       | ...
3ACKC002AR     | 1            | 1            | 1       | ...
3ACKC003AR     | 1            | 1            | 0       | ...
```
为3个机柜分别生成对应的报警点。

### 注意事项

1. **Excel格式要规范**：列名必须完全匹配，不能有额外的空格或特殊字符

2. **数量要准确**：报警数量填0表示不生成该类型报警，大于0则生成对应数量

3. **机柜名称要正确**：必须与机柜清单中的机柜名称完全一致，否则无法关联

4. **不要重复添加**：同一机柜的相同报警类型不要重复添加，会导致信号位号冲突

5. **预留板卡要充足**：如果选择通讯报警，需要确保预留的通讯报警板卡通道足够

6. **RTU信息要完整**：RTU板卡位置和端子板号要正确填写，用于后续接线图生成

7. **温度信号是AI**：温度信号会生成AI类型，其他报警都是DI类型

8. **序号从1开始**：即使只有1个报警，序号也是1（如PWFA1，而不是PWFA）

### 常见问题

**问题1：提示"Excel文件缺少必需列"**
- 原因：Excel表格缺少某些必需列
- 解决：检查列名是否完全匹配，补充缺失的列

**问题2：提示"机柜名称不能为空"**
- 原因：某些行的机柜名称列为空
- 解决：填写完整的机柜名称，删除空白行

**问题3：提示"信号位号已存在"**
- 原因：生成的信号位号与现有数据重复
- 解决：检查是否已添加过该机柜的报警点，删除重复数据后重新添加

**问题4：预览时看不到数据**
- 原因：选择的工作表为空或格式不正确
- 解决：检查工作表是否有数据，确认是否选择了正确的工作表

**问题5：通讯报警点未分配**
- 原因：预留的通讯报警板卡通道不够
- 解决：增加预留板卡数量，或减少报警点数量

**问题6：报警数量填错了**
- 原因：Excel中某个报警类型数量填写错误
- 解决：修改Excel数据后重新导入，或在IO清单中手动删除多余的信号

**问题7：温度信号分配失败**
- 原因：温度信号是AI类型，需要AI板卡
- 解决：确保有AI板卡可用，或将温度信号放入未分配列表手动分配

**问题8：RTU板卡位置格式错误**
- 原因：RTU板卡位置格式不是"机笼号-插槽号"
- 解决：修改为正确格式，如"1-01"、"2-03"等

**问题9：多个风扇故障信号位号重复**
- 原因：序号生成逻辑错误
- 解决：检查系统是否正确递增序号，如FAN1、FAN2、FAN3

**问题10：添加完成后看不到报警点**
- 原因：数据未刷新或筛选条件过滤了报警点
- 解决：刷新IO清单，检查筛选条件，确保报警类型信号可见

**问题11：报警点分配到错误的机柜**
- 原因：Excel中机柜名称与实际机柜不匹配
- 解决：检查Excel中的机柜名称是否正确，确保与机柜清单一致

**问题12：想修改已添加的报警点**
- 原因：添加后发现数据有误
- 解决：在IO清单中手动修改或删除，然后重新添加
