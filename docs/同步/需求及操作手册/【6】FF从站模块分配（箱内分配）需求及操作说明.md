# FF从站模块分配（箱内分配）需求及操作说明

## 一、需求文档

### 功能目标
我需要一个功能，能够在IO分配完成后，对已分配到FF板卡的从站信号进行箱内细化分配。FF从站箱包含多个从站模块（如AI模块、DI模块等），每个模块有多个通道。系统需要自动将信号分配到具体的模块和通道上，并分配站号。

### 触发时机
在"IO分配"完成后，如果检测到有FF从站信号（有从站模块型号的FF信号），自动触发箱内分配。也可以在"机柜分配预览"页面手动点击"重新分配模块"按钮触发。

### 前置条件
- 必须已完成"IO分配"，FF从站信号已分配到FF板卡的网段
- 信号必须有从站模块型号字段（FFSlaveModuleModel）
- 系统配置表中必须有从站模块的配置信息（模块类型、通道数等）

### 1. FF从站箱结构说明

FF从站箱的层级结构：
```
FF板卡
├── Net1（网段1）
│   ├── 从站模块1（站号01）- 如AI模块
│   │   ├── 通道1
│   │   ├── 通道2
│   │   └── ...
│   ├── 从站模块2（站号02）- 如DI模块
│   │   ├── 通道1
│   │   └── ...
│   └── ...
└── Net2（网段2）
    └── ...
```

### 2. 设备分组规则

箱内的信号需要先按设备分组，同一设备的信号要分配到一起：

#### 信号类型A（带扩展码）
- 识别规则：信号位号包含"_A"或"-A"
- 分组方式：取短横线或下划线后面的部分作为设备标识
- 示例：
  - `3FIC001_A1` → 设备组：`A1`
  - `3FIC001_A2` → 设备组：`A2`
  - `3FIC001-A1` → 设备组：`A1`

#### 信号类型D（数字量）
- 识别规则：信号位号包含"_D"或"-D"，或者IO类型为DI/DO
- 分组方式：使用完整位号作为设备标识
- 示例：
  - `3FIC001_D1` → 设备组：`3FIC001_D1`
  - `3FIC001_D2` → 设备组：`3FIC001_D2`

#### 混合信号
- 识别规则：同时有A信号和D信号的箱子
- 分组方式：
  - A信号按扩展码分组
  - D信号按完整位号分组
  - 分组时先判断是否为D信号，再判断A信号

### 3. 模块配置解析规则

从站模块配置使用文本格式描述，格式为："数量IO类型,数量IO类型,..."

#### 支持的格式
- 标准格式：`4AI,8DI` = 4个AI模块 + 8个DI模块
- 简化格式：`4A,8D` = 4个模拟量模块 + 8个数字量模块
- 单类型：`16DI` = 16个DI模块
- 多类型：`2AI,4AO,8DI,4DO` = 混合配置

#### 模块类型识别
- A/AI/AO → 模拟量模块
- D/DI/DO → 数字量模块
- 匹配规则：IO类型包含对应关键字即可

### 4. 网段模块合并规则

同一网段内可能有多个设备，每个设备有各自的模块配置，需要合并：

**合并步骤：**
1. 解析每个设备的模块配置
2. 按模块类型分组（A类一组，D类一组）
3. 合并相同类型模块的数量
4. 按优先级排序（AI→AO→DI→DO）

**示例：**
```
设备1配置：4AI,8DI
设备2配置：2AI,4DI
合并结果：6AI,12DI
```

### 5. 站号分配规则

站号从01开始，按模块顺序递增分配：

**分配原则：**
- 每个从站模块占用一个站号
- 站号在网段内连续编号
- 不同网段的站号独立计算

**示例：**
```
模块配置：4AI,8DI
AI模块1 → 站号01
AI模块2 → 站号02
AI模块3 → 站号03
AI模块4 → 站号04
DI模块1 → 站号05
DI模块2 → 站号06
...
DI模块8 → 站号12
```

### 6. 设备分配到模块规则

按设备组顺序，将信号分配到对应类型的模块：

**分配流程：**
1. 获取设备组的所有信号
2. 按IO类型分组（AI/AO/DI/DO）
3. 找到对应类型的第一个可用模块
4. 检查模块容量是否足够
5. 分配到模块的连续通道
6. 如果模块满了，切换到下一个同类型模块

**容量检查：**
- 每个模块都有最大通道数（从配置表获取）
- 同一设备的信号必须分配到同一个模块（不能跨模块）
- 如果单个设备信号数超过模块容量，标记为未分配

### 7. 通道号分配规则

每个模块内的通道从1开始编号：

**分配原则：**
- 按设备顺序分配通道
- 同一设备的信号占用连续通道
- 填满一个模块后，切换到下一个同类型模块
- 通道号在模块内部独立计算

**示例：**
```
AI模块1（4通道）：
- 设备A的AI信号1 → 通道1
- 设备A的AI信号2 → 通道2
- 设备B的AI信号1 → 通道3
- 设备B的AI信号2 → 通道4

DI模块1（8通道）：
- 设备A的DI信号1 → 通道1
- 设备A的DI信号2 → 通道2
- ...
```

### 8. 分配结果字段

分配完成后，每个FF从站信号会填充：
- **站号（FFDPStaionNumber）**：从站模块的站号（如"01"、"02"）
- **通道号（FFTerminalChannel）**：模块内的通道号（如1、2、3）
- **网段类型（NetType）**：Net1或Net2（从IO分配继承）

### 9. 未分配信号处理

如果信号无法分配，会保留在网段的"未分配信号"列表中：

**未分配原因：**
- 找不到对应IO类型的模块
- 模块通道容量不足（单个设备信号数超过模块容量）
- 模块配置格式错误
- 设备分组失败

**处理方式：**
- 未分配信号的站号和通道号为空
- 在机柜预览中显示在网段下方的"未分配信号"区域
- 可以手动调整模块配置后重新分配

### 10. 分配报告

分配完成后生成详细报告，包括：
- 网段信息（Net1/Net2）
- 设备分组统计（找到多少个设备组）
- 模块合并结果（合并后的模块配置）
- 每个模块的信号分配情况
- 未分配信号统计及原因

---

## 二、用户手册

### 操作步骤

#### 第一步：完成IO分配
1. 确保已完成"IO分配"操作
2. 确认FF从站信号已分配到FF板卡的网段
3. 检查信号的从站模块型号字段是否已填充

#### 第二步：触发箱内分配
有两种触发方式：

**自动触发：**
- IO分配完成后自动执行箱内分配
- 系统会显示"正在分配FF从站模块..."进度提示

**手动触发：**
- 在"机柜分配预览"页面查看分配结果
- 点击FF板卡的"重新分配模块"按钮
- 系统重新执行箱内分配

#### 第三步：查看分配结果
1. 在机柜预览界面查看FF板卡
2. 展开网段（Net1/Net2）
3. 查看每个从站模块的站号
4. 查看模块内的信号及通道号
5. 检查是否有未分配信号

#### 第四步：验证分配
1. 在IO清单中检查FF从站信号的站号和通道号是否已填充
2. 抽查几个设备，确认同一设备的信号分配到同一模块
3. 确认站号连续性（01、02、03...）
4. 确认通道号在模块内连续

### 配置示例

**示例1：单设备单模块**
```
设备：3FIC001
信号：3FIC001_A1（2个AI）
模块配置：4AI

分配结果：
AI模块（站号01）：
  - 3FIC001_A1_AI1 → 通道1
  - 3FIC001_A1_AI2 → 通道2
```

**示例2：多设备多模块**
```
箱号：JXX-001
设备：3FIC001_A1（3个AI，5个DI）
      3FIC001_A2（1个AI，3个DI）
模块配置：4AI,8DI

分配结果：
AI模块1（站号01）：
  - 3FIC001_A1_AI1 → 通道1
  - 3FIC001_A1_AI2 → 通道2
  - 3FIC001_A1_AI3 → 通道3
  - 3FIC001_A2_AI1 → 通道4

DI模块1（站号02）：
  - 3FIC001_A1_DI1 → 通道1
  - 3FIC001_A1_DI2 → 通道2
  - 3FIC001_A1_DI3 → 通道3
  - 3FIC001_A1_DI4 → 通道4
  - 3FIC001_A1_DI5 → 通道5
  - 3FIC001_A2_DI1 → 通道6
  - 3FIC001_A2_DI2 → 通道7
  - 3FIC001_A2_DI3 → 通道8
```

**示例3：混合信号（A+D）**
```
箱号：JXX-002
信号：3FIC001_A1（2个AI）
      3FIC001_D1（4个DI）
      3FIC001_D2（4个DI）
模块配置：4AI,16DI

分配结果：
AI模块1（站号01）：
  - 3FIC001_A1_AI1 → 通道1
  - 3FIC001_A1_AI2 → 通道2

DI模块1（站号02）：
  - 3FIC001_D1_DI1 → 通道1
  - 3FIC001_D1_DI2 → 通道2
  - 3FIC001_D1_DI3 → 通道3
  - 3FIC001_D1_DI4 → 通道4
  - 3FIC001_D2_DI1 → 通道5
  - 3FIC001_D2_DI2 → 通道6
  - 3FIC001_D2_DI3 → 通道7
  - 3FIC001_D2_DI4 → 通道8
```

### 注意事项

1. **模块配置要准确**：从站模块型号对应的配置必须在配置表中正确设置，格式为"数量IO类型"

2. **设备命名要规范**：
   - A信号建议使用`位号_A1`、`位号_A2`格式
   - D信号建议使用`位号_D1`、`位号_D2`格式
   - 同一设备的信号要有相同的设备前缀

3. **模块容量要合理**：单个设备的信号数不能超过单个模块的通道数，否则无法分配

4. **IO类型要匹配**：信号的IO类型必须与模块类型匹配（AI信号分配到AI模块，DI信号分配到DI模块）

5. **网段要正确**：FF从站信号必须已分配到网段（Net1或Net2），否则无法进行箱内分配

6. **重新分配会清空**：点击"重新分配模块"会清空之前的站号和通道号，重新分配

7. **未分配信号需检查**：如果有未分配信号，需要检查模块配置是否正确，或手动调整

8. **站号不可重复**：同一网段内的站号不能重复，系统会自动按顺序分配

### 常见问题

**问题1：提示"找不到对应IO类型的模块"**
- 原因：信号的IO类型与模块配置不匹配（如AO信号但只配置了AI模块）
- 解决：检查模块配置，补充缺失的模块类型（如添加AO模块）

**问题2：提示"设备信号数超过模块通道容量"**
- 原因：单个设备的信号数量超过了单个模块的最大通道数
- 解决：
  - 增加模块数量（如从4AI改为8AI）
  - 拆分设备（将大设备拆成多个小设备）
  - 检查信号是否归类错误

**问题3：设备分组不正确**
- 原因：信号位号命名不规范，无法正确识别设备
- 解决：
  - 检查信号位号格式是否符合规范
  - A信号应该有"_A1"或"-A1"标识
  - D信号应该有"_D"或"-D"标识

**问题4：站号不连续或重复**
- 原因：手动修改过站号，或分配逻辑异常
- 解决：点击"重新分配模块"按钮，重新自动分配站号

**问题5：通道号为空**
- 原因：信号未成功分配到模块
- 解决：检查未分配信号列表，查看具体未分配原因

**问题6：不同设备的信号分配到同一个模块**
- 原因：这是正常的，多个设备可以共享一个模块的不同通道
- 说明：只要模块容量够用，多个设备分配到同一模块是允许的

**问题7：模块配置格式错误**
- 原因：模块配置字符串格式不正确
- 解决：检查格式是否为"数量IO类型"，如：
  - 正确：`4AI,8DI`
  - 错误：`4个AI,8个DI`、`AI4,DI8`

**问题8：A信号和D信号混在一起**
- 原因：信号位号既有A标识又有D标识，识别混乱
- 解决：规范信号位号命名，A信号和D信号要有明确区分

**问题9：重新分配后数据丢失**
- 原因：重新分配会清空旧的站号和通道号
- 解决：重新分配前备份数据；重新分配后检查结果

**问题10：预览界面看不到模块**
- 原因：箱内分配未执行，或执行失败
- 解决：
  - 确认IO分配已完成
  - 手动点击"重新分配模块"按钮
  - 查看错误提示信息
