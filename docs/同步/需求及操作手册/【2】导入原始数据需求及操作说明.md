# 导入原始数据需求及操作说明

## 一、需求文档

### 功能目标
我需要一个功能，能够将"汇总.xlsx"文件中的数据导入到IO清单中。由于"汇总.xlsx"的表头是从各种设计院文件中提取出来的，命名不规范，所以导入前需要先根据控制系统类型进行表头标准化，然后才能正确导入到系统中。

### 1. 导入前提条件
- 必须先完成"提取PDF"功能，生成"汇总.xlsx"文件
- 当前子项目必须已选择控制系统类型（龙鳍、中控、龙核、一室、安全级模拟系统）
- 系统配置表（config_controlSystem_mapping）中必须有对应控制系统的字段映射配置

### 2. 表头标准化规则
导入前会自动对"汇总.xlsx"进行表头标准化：
- 读取配置表，获取当前控制系统的旧字段名与标准字段名的映射关系
- 将Excel表头中能匹配上的旧字段名替换为标准字段名
- 匹配不上的列保持原样（但可能导致导入后该列数据丢失）
- 标准化完成后保存覆盖"汇总.xlsx"

### 3. 数据导入规则
- 打开标准化后的"汇总.xlsx"文件
- 读取所有工作表的数据（如果有多个主表，会依次读取）
- 根据标准字段名将数据映射到IoFullData模型
- 清空当前子项目的旧IO数据
- 批量插入新数据到数据库
- 刷新界面显示

### 4. 数据转换规则
- 字符串类型：直接赋值
- 数值类型（int、float、double）：尝试转换，失败则使用默认值（0或null）
- 布尔类型：尝试转换，失败则使用false
- 日期类型：尝试转换，失败则使用null
- 枚举类型（如TagType、盘箱柜类别）：根据字符串值或整数值映射

### 5. 执行前确认
导入前会弹窗确认：
- 提示"确认导入原始数据？此操作将清空当前子项目的所有IO数据！"
- 用户确认后才执行导入
- 导入过程显示进度提示

### 6. 异常处理
- 如果"汇总.xlsx"文件不存在，提示"请先完成提取PDF操作"
- 如果配置表缺少映射，提示"配置表中缺少XX控制系统的字段映射"
- 如果Excel表头与标准字段完全不匹配，提示"表头标准化失败，请检查配置表"
- 导入失败时回滚事务，不清空原有数据

---

## 二、用户手册

### 操作步骤

#### 第一步：完成数据提取
1. 先使用"提取PDF"功能，生成"汇总.xlsx"文件
2. 确认"汇总.xlsx"文件在输出目录中存在

#### 第二步：选择控制系统
确认当前子项目的控制系统类型已正确选择（如果未选择，需要先在项目配置中设置）

#### 第三步：导入原始数据
1. 点击"导入原始数据"按钮
2. 选择"汇总.xlsx"文件（默认会定位到提取PDF时设置的输出目录）
3. 系统自动进行表头标准化
4. 弹窗确认是否导入（会提示将清空现有数据）
5. 点击"确认"开始导入

#### 第四步：验证结果
1. 导入完成后，界面会自动刷新显示新数据
2. 检查数据数量是否与Excel中的行数一致
3. 抽查几条数据，确认字段值是否正确

### 注意事项

1. **数据会被清空**：导入操作会清空当前子项目的所有IO数据，请确认无误后再执行

2. **控制系统类型要准确**：表头标准化依赖控制系统类型，选错会导致字段映射不正确

3. **表头必须在第一行**：Excel文件的第一行必须是表头，数据从第二行开始

4. **配置表要完整**：如果提示"额外列"或"缺失列"，需要先在数据资产中心的配置表中补充映射

5. **多个主表的处理**：如果"汇总.xlsx"中有多个工作表（因为列数不同而分组），系统会依次读取所有工作表的数据

6. **数据类型转换失败**：如果Excel中的数值格式不正确（如数字列中有文字），该单元格会使用默认值，导入后需检查

### 常见问题

**问题1：提示"汇总.xlsx不存在"**
- 原因：未执行"提取PDF"功能，或文件被手动删除/移动
- 解决：先完成"提取PDF"操作，确保文件存在

**问题2：导入后数据缺失**
- 原因：表头标准化时部分列未匹配上
- 解决：在配置表（config_controlSystem_mapping）中补充该控制系统的字段映射

**问题3：提示"表头标准化失败"**
- 原因：Excel表头与配置表中的旧字段名完全不匹配
- 解决：检查控制系统选择是否正确；或手动修改Excel表头为标准字段名

**问题4：数据导入失败回滚**
- 原因：数据格式错误、必填字段缺失、数据库约束冲突等
- 解决：查看错误提示，修正Excel数据后重新导入

**问题5：导入后部分字段为空或默认值**
- 原因：Excel中该列数据类型与数据库字段类型不匹配，转换失败
- 解决：检查Excel数据格式，确保数值列为数字格式，日期列为日期格式

**问题6：导入速度慢**
- 原因：数据量大（几千行以上）
- 解决：耐心等待，系统会显示"正在导入..."进度提示；批量插入已优化性能
