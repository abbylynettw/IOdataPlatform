# IO输入输出表预处理功能规则详解

## 一、需求文档

### 功能目标
我需要一个功能，能够从设计院提供的各种格式文件（PDF、Word、Excel）中提取IO输入输出表数据，并自动合并成统一的Excel文件。由于不同设计院、不同项目的表头命名不一致，我还需要根据控制系统类型将这些不规范的表头统一转换为我们系统的标准字段名，这样后续才能正确导入到IO清单中进行分配和计算。

### 1. 文件要求
- 可以处理的文件：PDF、Word文档（.doc/.docx）、Excel文件（.xls/.xlsx）
- 文件名不能重复（不区分大小写），否则合并时后面的会覆盖前面的
- 必须先选好输出目录，没有的话会自动创建

### 2. 提取规则

#### Excel文件提取
- 新版Excel（.xlsx）：直接复制到输出目录
- 老版Excel（.xls）：转换成新版格式（.xlsx）后保存到输出目录

#### PDF和Word文件提取
- 从文件中找到所有表格
- 每个表格单独生成一个工作表
- 表格单元格内的文字会自动清理以下特殊字符：
  - 换行符（\n）
  - 回车符（\r）
  - 响铃符（\a）
- 最后保存成与原文件同名的Excel文件

#### 处理速度
- 所有文件同时处理，不用一个一个等

## 3. 合并规则

我需要把所有提取出来的Excel文件合并成一个"汇总.xlsx"：

- 把所有工作表都收集到一起
- 按列数分组：只有列数相同的表才能合并（避免错位）
- 每组选一个主表，其他表的数据追加到主表后面
- 删除重复行和空白行
- 最终生成"汇总.xlsx"，如果有不同列数的表，会保留多个主表

### 4. 表头标准化规则

不同设计院给的表头名字五花八门（比如"信号位号"可能写成"Tag"、"标签"、"位号"等），我需要统一改成系统认可的标准名称：

- 系统有配置表，记录了各个控制系统（龙鳍、中控、龙核、一室、安全级模拟系统）的旧字段名和标准字段名对应关系
- 读取"汇总.xlsx"的表头，对照配置表进行重命名
- 能对应上的改成标准名称，对应不上的保持原样
- 如果配置表里有但Excel里找不到，提示"缺失列"
- 如果Excel里有但配置表没定义，提示"额外列"，需要补充映射

### 5. 执行前检查与特殊情况

**执行前必须满足：**
- 文件列表不能为空
- 必须选择输出目录（不存在会自动创建）

**特殊情况说明：**
- **同名文件**：如果列表里有文件名重复（比如都叫"IO表.pdf"），系统会阻止执行，避免覆盖
- **列数不一致**：不同文件的表格列数不一样时，合并后会分成多个主表，建议处理前先统一列数
- **PDF识别不准**：格式复杂的PDF表格识别效果差，建议先转成Word确保表格结构清晰

---

## 二、用户手册

### 操作步骤

#### 第一步：选择输出目录
1. 点击"选择输出目录"按钮
2. 建议选择空目录或新建专用目录，避免文件覆盖冲突

#### 第二步：添加待处理文件
1. 点击"添加文件"按钮
2. 支持多选，可同时选择pdf、doc、docx、xls、xlsx格式文件
3. 确认文件列表中无同名文件（不区分大小写）
4. 若需移除文件，点击文件行的删除按钮；若需清空列表，点击"清空文件列表"

#### 第三步：执行提取与合并
1. 点击"确认"或"开始处理"按钮
2. 系统自动并发提取所有文件，生成同名.xlsx到输出目录
3. 提取完成后自动合并，生成"汇总.xlsx"
4. 等待状态提示"已成功将信息提取到指定目录"

#### 第四步：表头标准化（可选）
1. 点击IO表标准字段名，即复制，粘贴到"汇总.xlsx"，将旧表头重命名为标准字段。

2. 若提示存在额外列或缺失列，需到数据资产中心的config_controlSystem_mapping表补充映射配置

   ![image-20251119151025374](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20251119151025374.png)

#### 第五步：检查结果
1. 点击文件行的"打开结果"按钮，查看对应的.xlsx文件
2. 打开"汇总.xlsx"，检查合并结果与表头标准化效果
3. 若需重新处理，清空文件列表后重复以上步骤

### 注意事项

1. **文件名重复问题**：若列表中存在同名文件（不区分大小写），系统会在执行时阻止并提示"列表中有两个或多个文件名相同，如果开始提取，一部分结果文件会被覆盖"

2. **合并结果分组**：由于按列数分组，若源文件列数不一致，"汇总.xlsx"中可能存在多个主表（多个工作表），需逐表检查数据完整性

3. **表头标准化前提**：必须先执行提取与合并，生成"汇总.xlsx"后，才能执行表头标准化

4. **映射配置维护**：若提示存在额外列或缺失列，需在数据资产中心的config_controlSystem_mapping表中新增或修正映射关系，确保StdField与IoFullData模型的DisplayAttribute一致

5. **PDF表格识别**：对于表格结构复杂、识别效果差的PDF文件，建议先手动转换为Word格式（保持表格结构），再添加到列表中处理

6. **输出目录管理**：每次执行会覆盖同名文件，建议不同批次使用不同输出目录，或在执行前备份已有结果

### 常见问题

**问题1：提示"结果文件不存在，请先处理"**
- 原因：未执行提取操作，或提取过程中出现错误
- 解决：确认已点击"确认"按钮并等待提取完成；检查文件格式是否正确

**问题2："汇总.xlsx"为空或数据缺失**
- 原因：源文件中无有效表格，或表格提取失败
- 解决：检查源文件是否包含表格结构；对于PDF文件，尝试转换为Word后再处理

**问题3：表头标准化不生效**
- 原因：选择的控制系统类型与实际不符，或配置表中缺少映射
- 解决：确认控制系统选择正确；检查config_controlSystem_mapping表中是否存在对应旧字段与StdField的映射关系

**问题4：合并后"汇总.xlsx"存在多个工作表**
- 原因：源文件列数不一致，按列数分组后产生多个主表
- 解决：这是正常现象，分别检查每个工作表的数据；若需合并为一个表，需手动调整源文件列数一致后重新处理

**问题5：提示"以下Excel中的列未在配置表中映射"**
- 原因：Excel表头中存在配置表未定义的列
- 解决：到数据资产中心的config_controlSystem_mapping表中新增该列的映射关系（StdField及对应控制系统的旧字段列）

**问题6：处理速度慢或卡顿**
- 原因：文件数量多或文件较大，Word/Excel组件占用资源
- 解决：分批处理；关闭其他占用内存的程序；处理完成后系统会自动执行GC释放资源
