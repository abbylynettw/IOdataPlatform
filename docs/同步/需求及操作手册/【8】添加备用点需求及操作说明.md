# 添加备用点需求及操作说明

## 一、需求文档

### 功能目标
我需要一个功能，能够为所有已分配的板卡自动添加备用点。备用点占用板卡的空闲通道，用于系统扩展和维护。系统要自动检测每块板卡的空闲通道，为每个空闲通道生成一个备用信号，并继承该板卡已有信号的属性（如IO类型、供电类型等）。

### 触发时机
在IO清单页面或机柜管理页面，点击"添加备用点"按钮。

### 前置条件
- 必须已完成"IO分配"，信号已分配到板卡
- 板卡必须至少有一个已分配的正常信号（用于继承属性）
- DP板卡和FF板卡不支持添加备用点

### 1. 备用点定义

**备用点特征：**
- 信号类型：TagType.BackUp
- 用途：预留通道，用于后续系统扩展
- 位置：占用已分配板卡的空闲通道
- 属性：继承同板卡已有信号的属性

### 2. 生成规则

#### 遍历所有板卡
系统会遍历所有机柜的所有机笼的所有插槽：
- 跳过空插槽（Board == null）
- 跳过DP板卡（卡型号包含"DP"）
- 跳过FF板卡（卡型号包含"FF"）
- 只处理已安装板卡的空闲通道

#### 空闲通道检测
对于每块板卡：
- 获取板卡总通道数（从配置表获取）
- 检查每个通道是否已占用（Point != null）
- 找出所有空闲通道（Point == null）

#### 属性继承规则
备用点继承同板卡已有信号的属性：
- **IO类型**：与板卡上已有信号相同（如AI、DI、DO等）
- **供电类型**：与板卡上已有信号相同
- **卡型号**：板卡的卡型号
- **电气特性**：与已有信号相同
- **信号有效方式**：与已有信号相同
- **子网号**：与已有信号相同（如有）
- **站号**：与已有信号相同（如有）

### 3. 信号命名规则

#### 命名格式
```
{机柜号}{机笼号}{插槽号}{卡类型前2位}CH{通道号}
```

#### 示例
- 机柜：3ACKC001AR
- 机笼：1
- 插槽：05
- 卡型号：AI201
- 通道：12
- 生成位号：`3ACKC001AR105AICH12`

### 4. 信号字段填充

每个备用点会填充以下字段：

| 字段名 | 填充规则 | 示例 |
|:------|:---------|:-----|
| 信号位号（SignalPositionNumber） | 按命名规则生成 | 3ACKC001AR105AICH12 |
| 系统代码（SystemCode） | 固定为"BEIYONG" | BEIYONG |
| 信号描述（Description） | 固定为"备用" | 备用 |
| 机柜号（CabinetNumber） | 继承 | 3ACKC001AR |
| 机笼号（Cage） | 继承 | 1 |
| 插槽号（Slot） | 继承 | 5 |
| 通道号（Channel） | 空闲通道编号 | 12 |
| 卡型号（CardType） | 继承 | AI201 |
| IO类型（IoType） | 继承 | AI |
| 供电类型（PowerType） | 继承 | AI1 |
| 电气特性（ElectricalCharacteristics） | 继承 | 4-20mA |
| 信号有效方式（SignalEffectiveMode） | 继承 | H |
| 信号类型（PointType） | 固定为BackUp | BackUp |
| 版本（Version） | 固定为"A" | A |
| 修改时间（ModificationDate） | 当前时间 | 2025-11-19 10:30:00 |

### 5. 批量处理规则

#### 按机柜分组
- 先按机柜分组处理
- 再按机笼分组
- 最后按插槽分组
- 按卡型号分组

#### 通道编号计算
对于每块板卡：
1. 获取板卡总通道数（如16通道）
2. 获取已占用通道列表（如[1, 2, 3, 5, 7]）
3. 计算空闲通道（如[4, 6, 8, 9, 10, 11, 12, 13, 14, 15, 16]）
4. 为每个空闲通道生成备用点

### 6. 异常处理

#### 板卡无已分配信号
- 现象：板卡所有通道都为空
- 处理：跳过该板卡，不生成备用点
- 原因：无法继承属性

#### 卡型号配置缺失
- 现象：找不到板卡对应的配置信息
- 处理：抛出异常，提示补充配置
- 信息：`找不到{CardType}板卡类型`

### 7. 添加结果

添加完成后：
- 将所有备用点插入到IO清单
- 刷新数据并重新排序
- 自动保存到数据库
- 显示添加数量统计

### 8. 删除备用点

#### 删除规则
- 删除所有信号类型为BackUp的记录
- 不影响其他类型的信号
- 删除前需确认

#### 删除流程
1. 统计备用点数量
2. 弹窗确认是否删除
3. 删除所有备用点
4. 保存并刷新数据

---

## 二、用户手册

### 操作步骤

#### 添加备用点

**第一步：进入功能页面**
- 方式1：在IO清单页面点击"添加备用点"按钮
- 方式2：在机柜管理页面点击"添加备用点"按钮

**第二步：等待处理**
1. 系统显示"正在添加备用点..."
2. 自动遍历所有机柜
3. 检测所有板卡的空闲通道
4. 生成备用信号

**第三步：查看结果**
1. 系统显示"备用点添加完毕"
2. 提示添加的数量（如"总计添加: 342 个备用点"）
3. 数据自动保存
4. IO清单自动刷新

#### 删除备用点

**第一步：点击删除按钮**
- 在功能页面点击"删除备用点"按钮

**第二步：确认删除**
1. 系统提示"确认删除全部 XXX 个备用点吗？"
2. 点击"确认"继续
3. 点击"取消"放弃删除

**第三步：完成删除**
1. 系统显示"正在删除备用点..."
2. 删除所有备用点
3. 提示删除数量
4. 数据自动保存

### 使用场景

**场景1：新系统初始配置**
- IO分配完成后，立即添加备用点
- 为后续扩展预留通道
- 便于接线时预留端子

**场景2：导出完整配置表**
- 导出前添加备用点
- 确保表格包含所有通道
- 方便查看板卡利用率

**场景3：系统扩展预留**
- 预留备用通道用于未来扩展
- 避免后期再次修改接线
- 提前规划端子排布局

### 注意事项

1. **DP和FF板卡不支持**：DP板卡和FF板卡的通道结构特殊，不支持添加备用点

2. **必须先有正常信号**：板卡至少要有一个正常信号，否则无法继承属性

3. **会占用大量空间**：如果板卡空闲通道很多，备用点会占用大量数据空间

4. **删除需谨慎**：删除备用点是批量操作，会删除所有备用点，无法撤销

5. **属性完全继承**：备用点的所有属性（IO类型、供电等）都继承自同板卡的已有信号

6. **通道编号连续**：系统会填充所有空闲通道，不会跳过

7. **位号自动生成**：备用点位号按规则自动生成，不能手动修改

8. **添加会覆盖**：重复添加备用点会跳过已有的备用点，只添加新的空闲通道

### 常见问题

**问题1：提示"找不到XXX板卡类型"**
- 原因：配置表缺少该卡型号的配置
- 解决：在"IO卡型号配置表"中添加该卡型号及通道数配置

**问题2：某些板卡没有生成备用点**
- 原因：可能是DP板卡或FF板卡，或板卡没有已分配信号
- 解决：检查板卡类型，DP和FF不支持；确保板卡有至少一个正常信号

**问题3：备用点数量不对**
- 原因：某些通道已被占用（如预留信号）
- 解决：备用点只占用完全空闲的通道，已占用通道会跳过

**问题4：备用点的IO类型错误**
- 原因：继承了错误的信号属性
- 解决：检查同板卡的正常信号IO类型是否正确，修正后删除备用点重新添加

**问题5：想删除单个机柜的备用点**
- 原因：只想删除部分备用点
- 解决：在IO清单中筛选该机柜和备用点类型，手动删除

**问题6：备用点占用太多空间**
- 原因：每个空闲通道都生成了备用点
- 解决：根据实际需要决定是否添加备用点；或只在导出前临时添加

**问题7：添加后导出表格很大**
- 原因：备用点增加了大量记录
- 解决：导出前可以选择筛选掉备用点类型

**问题8：重复添加会重复吗**
- 原因：担心多次点击会生成重复数据
- 解决：系统会跳过已有备用点的通道，不会重复

**问题9：删除备用点后能恢复吗**
- 原因：误删除了备用点
- 解决：无法撤销，需要重新点击"添加备用点"

**问题10：备用点的信号位号能修改吗**
- 原因：想自定义备用点的位号
- 解决：位号是自动生成的，如需修改可在IO清单中手动编辑
